<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mehmet Emir AI</title>

  <!-- PWA / iPhone "Ana Ekrana Ekle" -->
  <meta name="theme-color" content="#202123">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mehmet Emir AI">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#343541;
      --panel:#40414f;
      --panel2:#202123;
      --side:#111214;
      --side2:#0c0d0f;
      --text:#ececf1;
      --muted:#c5c5d2;
      --border:rgba(255,255,255,.12);
      --green:#19c37d;
      --danger:#ff4d4d;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:#8ad0ff}

    /* Layout */
    .app{display:grid;grid-template-columns:300px 1fr;min-height:100vh}
    .main{display:flex;flex-direction:column;min-width:0}

    /* Sidebar */
    .sidebar{
      background:linear-gradient(180deg,var(--side),var(--side2));
      border-right:1px solid rgba(255,255,255,.08);
      display:flex;flex-direction:column;
      padding:12px;gap:10px;
      overflow:hidden;
    }
    .sbTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;gap:10px;align-items:center;min-width:0}
    .logoBox{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, var(--green), #7aa7ff, #b36bff);
      background-size:220% 220%;
      animation: glowMove 6s linear infinite;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      box-shadow:0 10px 25px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logoBox span{font-weight:1000;letter-spacing:.5px;color:#07110a;font-size:14px;text-shadow:0 1px 0 rgba(255,255,255,.35)}
    @keyframes glowMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .brandText{min-width:0;display:flex;flex-direction:column;gap:2px}
    .brandText b{
      font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      background: linear-gradient(90deg,#e7e7ff,#8ad0ff,#e7e7ff);
      background-size:200% 100%;
      -webkit-background-clip:text;color:transparent;
      animation:titleShine 5s linear infinite;
    }
    @keyframes titleShine{0%{background-position:0%}100%{background-position:200%}}
    .brandText small{color:rgba(197,197,210,.85);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .sbBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
      display:flex;align-items:center;justify-content:center;gap:8px;
    }
    .sbBtn:hover{background:rgba(255,255,255,.10)}
    .sbBtn.green{border-color:rgba(25,195,125,.55); background:rgba(25,195,125,.12)}
    .sbBtn.danger{border-color:rgba(255,77,77,.45); background:rgba(255,77,77,.10)}
    .sbTools{display:grid;grid-template-columns:1fr 1fr; gap:8px}
    .sbSearch{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-weight:700;
    }
    .chats{
      margin-top:8px;
      display:flex;flex-direction:column;gap:6px;
      overflow:auto;padding-right:2px;flex:1 1 auto;
    }
    .chatItem{
      display:flex;gap:8px;align-items:center;justify-content:space-between;
      padding:10px 10px;border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04);
      cursor:pointer;
    }
    .chatItem:hover{background:rgba(255,255,255,.08)}
    .chatItem.active{background:rgba(25,195,125,.12);border-color:rgba(25,195,125,.35)}
    .chatTitle{
      font-size:13px;font-weight:850;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;
    }
    .chatMeta{color:rgba(197,197,210,.75);font-size:11px;font-family:var(--mono);white-space:nowrap}
    .chatActions{display:flex;gap:6px;flex:0 0 auto}
    .iconBtn{
      width:30px;height:30px;border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .iconBtn:hover{background:rgba(255,255,255,.10)}
    .iconBtn.red{border-color:rgba(255,77,77,.45); background:rgba(255,77,77,.10)}
    .sbFooter{border-top:1px solid rgba(255,255,255,.08);padding-top:10px;display:flex;flex-direction:column;gap:8px}
    .note{color:rgba(197,197,210,.85);font-size:12px}

    /* Topbar */
    .topbar{
      position:sticky;top:0;z-index:10;
      background:var(--panel2);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;
    }
    .topLeft{display:flex;align-items:center;gap:10px;min-width:0}
    .burger{
      display:none;
      width:40px;height:40px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-size:18px;font-weight:1000;
    }
    .burger:hover{background:rgba(255,255,255,.10)}

    /* ZenoAI mini label */
    .miniBrand{
      font-size:12px;
      font-weight:900;
      color:rgba(197,197,210,.9);
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      line-height:1;
      user-select:none;
    }

    .topbar .title{
      font-weight:950;font-size:14px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      max-width:60vw;
    }
    .topbar .sub{font-size:12px;color:rgba(197,197,210,.85)}
    .topbarRight{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      font-size:13px
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.green{border-color:rgba(25,195,125,.55); background:rgba(25,195,125,.12)}

    /* Chat */
    .chatArea{
      flex:1 1 auto;
      padding:16px 14px 120px;
      max-width:980px;width:100%;
      margin:0 auto;
    }
    .row{display:flex;gap:14px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .row:last-child{border-bottom:none}
    .avatar{
      width:34px;height:34px;border-radius:10px;flex:0 0 auto;
      display:grid;place-items:center;font-weight:900;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10)
    }
    .avatar.me{background:rgba(122,167,255,.16);border-color:rgba(122,167,255,.35)}
    .avatar.bot{background:rgba(109,70,255,.14);border-color:rgba(109,70,255,.35)}
    .bubble{flex:1;white-space:pre-wrap;word-break:break-word;line-height:1.55;font-size:15px}
    .meta{margin-top:6px;font-size:12px;color:rgba(197,197,210,.85);font-family:var(--mono)}
    .composer{
      position:fixed;left:300px;right:0;bottom:0;
      background:linear-gradient(180deg, rgba(52,53,65,0), rgba(52,53,65,.95) 35%, rgba(52,53,65,1));
      padding:14px;
      z-index:9;
    }
    .composer .inner{
      max-width:980px;margin:0 auto;background:var(--panel);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;display:flex;gap:10px;
      padding:10px;align-items:flex-end;box-shadow:0 18px 40px rgba(0,0,0,.35)
    }
    textarea{
      flex:1;background:transparent;color:var(--text);
      border:none;outline:none;resize:none;
      min-height:44px;max-height:160px;font-size:15px;line-height:1.45
    }
    .send{
      background:var(--green);color:#052016;border:none;border-radius:12px;
      padding:10px 14px;font-weight:950;cursor:pointer;min-width:90px
    }
    .send:disabled{opacity:.55;cursor:not-allowed}
    .hintbar{max-width:980px;margin:10px auto 0;display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);border-radius:999px;padding:7px 10px;cursor:pointer;user-select:none}
    .chip:hover{background:rgba(255,255,255,.10)}

    /* Typing */
    .typing{display:inline-flex;gap:6px;align-items:center;color:rgba(236,236,241,.9);font-size:14px}
    .dot{width:6px;height:6px;border-radius:999px;background:rgba(236,236,241,.75);animation:bounce 1s infinite}
    .dot:nth-child(2){animation-delay:.12s}
    .dot:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-5px);opacity:1}}

    /* Google button inside message */
    .gbtn{
      display:inline-block;
      margin-top:10px;
      padding:9px 12px;
      background:var(--green);
      color:#052016;
      border-radius:12px;
      font-weight:950;
      text-decoration:none;
      border:1px solid rgba(25,195,125,.45);
    }
    .gbtn:hover{filter:brightness(1.05)}

    /* Mobile sidebar overlay */
    .overlay{
      display:none;
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      z-index:20;
    }
    .sidebar.mobile{
      position:fixed;
      top:0;left:0;bottom:0;
      width:300px;
      transform:translateX(-105%);
      transition:transform .2s ease;
      z-index:21;
    }
    .sidebar.mobile.open{transform:translateX(0)}
    .overlay.show{display:block}

    @media (max-width: 900px){
      .app{grid-template-columns:1fr}
      .burger{display:inline-grid;place-items:center}
      .sidebar{display:none}
      .sidebar.mobile{display:flex}
      .composer{left:0}
      .topbar .title{max-width:55vw}
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay"></div>

  <div class="app">

    <!-- DESKTOP SIDEBAR -->
    <aside class="sidebar" id="sidebarDesktop">
      <div class="sbTop">
        <div class="brand">
          <div class="logoBox"><span>AI</span></div>
          <div class="brandText">
            <b>Mehmet Emir AI</b>
            <small>Sohbetler</small>
          </div>
        </div>
      </div>

      <button class="sbBtn green" id="newChatBtnD">+ Yeni sohbet</button>
      <input class="sbSearch" id="sbSearchD" placeholder="Sohbet ara..." />

      <div class="sbTools">
        <button class="sbBtn" id="btnTopicsD">7. SÄ±nÄ±f</button>
        <button class="sbBtn" id="btnHelpD">Komutlar</button>
      </div>

      <div class="chats" id="chatListD"></div>

      <div class="sbFooter">
        <button class="sbBtn" id="btnNameD">Ä°sim Ayarla</button>
        <button class="sbBtn danger" id="wipeAllBtnD">Hepsini Sil</button>
        <div class="note">Her ÅŸey cihazÄ±nda saklanÄ±r.</div>
      </div>
    </aside>

    <!-- MOBILE SIDEBAR -->
    <aside class="sidebar mobile" id="sidebarMobile">
      <div class="sbTop">
        <div class="brand">
          <div class="logoBox"><span>AI</span></div>
          <div class="brandText">
            <b>Mehmet Emir AI</b>
            <small>Sohbetler</small>
          </div>
        </div>
        <button class="iconBtn" id="closeMobile" title="Kapat">Ã—</button>
      </div>

      <button class="sbBtn green" id="newChatBtnM">+ Yeni sohbet</button>
      <input class="sbSearch" id="sbSearchM" placeholder="Sohbet ara..." />

      <div class="sbTools">
        <button class="sbBtn" id="btnTopicsM">7. SÄ±nÄ±f</button>
        <button class="sbBtn" id="btnHelpM">Komutlar</button>
      </div>

      <div class="chats" id="chatListM"></div>

      <div class="sbFooter">
        <button class="sbBtn" id="btnNameM">Ä°sim Ayarla</button>
        <button class="sbBtn danger" id="wipeAllBtnM">Hepsini Sil</button>
        <div class="note">Her ÅŸey cihazÄ±nda saklanÄ±r.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <div class="topLeft">
          <button class="burger" id="burger" title="MenÃ¼">â‰¡</button>
          <span class="miniBrand">ZenoAI</span>
          <div style="min-width:0">
            <div class="title" id="topTitle">Mehmet Emir AI</div>
            <div class="sub">MenÃ¼ + yazÄ±yor animasyonu + Google buton</div>
          </div>
        </div>
        <div class="topbarRight">
          <button class="btn" id="renameBtn">Ad deÄŸiÅŸtir</button>
          <button class="btn green" id="clearBtn">Sohbeti temizle</button>
        </div>
      </header>

      <section class="chatArea" id="chatArea"></section>

      <div class="composer">
        <div class="inner">
          <textarea id="inp" placeholder='Bir ÅŸey yaz... (Ã¶rn: "Konu anlat: KarÄ±ÅŸÄ±mlar", "test: karÄ±ÅŸÄ±mlar", "telefonum neden yavaÅŸ")'></textarea>
          <button class="send" id="send">GÃ¶nder</button>
        </div>
        <div class="hintbar">
          <span class="chip" data-q="Benim adÄ±m Mehmet">Benim adÄ±mâ€¦</span>
          <span class="chip" data-q="7. sÄ±nÄ±f konular">7. sÄ±nÄ±f konular</span>
          <span class="chip" data-q="Konu anlat: KarÄ±ÅŸÄ±mlar">Konu anlat</span>
          <span class="chip" data-q="test: karÄ±ÅŸÄ±mlar">Test</span>
          <span class="chip" data-q="cumhuriyet ne zaman ilan edildi">Cumhuriyet</span>
          <span class="chip" data-q="telefonum neden yavaÅŸ">Google</span>
          <span class="chip" data-q="teÅŸekkÃ¼r ederim">TeÅŸekkÃ¼r</span>
        </div>
      </div>
    </main>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const now = () => new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
  const today = () => new Date().toLocaleDateString("tr-TR",{weekday:"long", year:"numeric", month:"long", day:"numeric"});

  function norm(s){
    return (s||"").toLowerCase()
      .replaceAll("Ä±","i").replaceAll("ÄŸ","g").replaceAll("Ã¼","u")
      .replaceAll("ÅŸ","s").replaceAll("Ã¶","o").replaceAll("Ã§","c")
      .replace(/[?!.,"'â€™]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  const store = {
    get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  const state = {
    appTitle: "Mehmet Emir AI",
    userName: store.get("mea_userName",""),
    convs: store.get("mea_convs", []),
    activeId: store.get("mea_activeId", null),
  };

  function saveAll(){
    store.set("mea_userName", state.userName);
    store.set("mea_convs", state.convs);
    store.set("mea_activeId", state.activeId);
  }

  function uid(){
    return "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function getActive(){
    return state.convs.find(c => c.id === state.activeId) || null;
  }

  function ensureOneConversation(){
    if(state.convs.length === 0){
      const id = uid();
      state.convs.push({
        id,
        title: "Yeni sohbet",
        createdAt: Date.now(),
        updatedAt: Date.now(),
        messages: [],
        _test: null
      });
      state.activeId = id;
      saveAll();
    }
    if(!state.activeId || !getActive()){
      state.activeId = state.convs[0].id;
      saveAll();
    }
  }

  function setActive(id){
    state.activeId = id;
    saveAll();
    renderAll();
  }

  // Mobile sidebar toggle
  const overlay = $("overlay");
  const sidebarMobile = $("sidebarMobile");
  function openMobileMenu(){
    overlay.classList.add("show");
    sidebarMobile.classList.add("open");
  }
  function closeMobileMenu(){
    overlay.classList.remove("show");
    sidebarMobile.classList.remove("open");
  }

  $("burger").onclick = openMobileMenu;
  $("closeMobile").onclick = closeMobileMenu;
  overlay.onclick = closeMobileMenu;

  // Google fallback (HTML)
  function googleAnswerHTML(question){
    const q = encodeURIComponent((question||"").trim());
    const url = `https://www.google.com/search?q=${q}`;
    return {
      text: `Bunu Googleâ€™da arayabilirsin ðŸ‘‡`,
      html: `Bunu Googleâ€™da arayabilirsin ðŸ‘‡\n\n<a class="gbtn" href="${url}" target="_blank" rel="noopener">Googleâ€™da Ara</a>`
    };
  }

  // Typewriter (final HTML clickable)
  function typewriter(el, htmlString, speed=12){
    const temp = document.createElement("div");
    temp.innerHTML = htmlString.replace(/\n/g,"<br>");
    const plain = temp.textContent || "";

    el.textContent = "";
    let i = 0;

    return new Promise(resolve => {
      const tick = () => {
        if(i < plain.length){
          el.textContent += plain.charAt(i);
          i++;
          setTimeout(tick, speed);
        } else {
          el.innerHTML = htmlString.replace(/\n/g, "<br>");
          resolve();
        }
      };
      tick();
    });
  }

  // Knowledge (kÄ±sa)
  const GRADE7 = {
    "Fen Bilimleri": ["GÃ¼neÅŸ Sistemi", "HÃ¼cre BÃ¶lÃ¼nmeleri", "Kuvvet-Enerji", "KarÄ±ÅŸÄ±mlar", "IÅŸÄ±k", "Elektrik Devreleri"],
    "Matematik": ["Tam SayÄ±lar", "Rasyoneller", "Oran-OrantÄ±", "YÃ¼zdeler", "Cebir", "Denklemler", "Veri Analizi"],
    "TÃ¼rkÃ§e": ["Paragraf", "YazÄ±m-Noktalama", "SÃ¶zcÃ¼k/CÃ¼mlede Anlam"],
    "Sosyal": ["KÃ¼ltÃ¼r ve Miras", "Etkin VatandaÅŸlÄ±k", "Ãœretim-DaÄŸÄ±tÄ±m-TÃ¼ketim"],
    "Din": ["Ahlak", "Ä°badet ve Dua"],
    "Ä°ngilizce": ["Daily Routines", "Likes/Dislikes"]
  };

  function listTopics(){
    let out = "7. sÄ±nÄ±f konu haritasÄ± (Ã¶zet):\n";
    for(const [k,v] of Object.entries(GRADE7)){
      out += `\nâ€¢ ${k}: ${v.join(", ")}`;
    }
    out += "\n\nKullanÄ±m:\n- \"Konu anlat: KarÄ±ÅŸÄ±mlar\"\n- \"test: karÄ±ÅŸÄ±mlar\"";
    return out;
  }

  const REPUBLIC = {
    proclamation: "TÃ¼rkiye Cumhuriyeti 29 Ekim 1923â€™te ilan edildi; Mustafa Kemal AtatÃ¼rk ilk cumhurbaÅŸkanÄ± seÃ§ildi.",
    republicDay: "29 Ekim Cumhuriyet BayramÄ± her yÄ±l 29 Ekimâ€™de kutlanÄ±r."
  };

  const MINI_TESTS = {
    "karisimlar": [
      {q:"Homojen karÄ±ÅŸÄ±m hangisidir?", a:["Kumlu su","Tuzlu su","YaÄŸ-su"], c:1},
      {q:"Tuzlu sudan tuzu ayÄ±rma yÃ¶ntemi?", a:["SÃ¼zme","BuharlaÅŸtÄ±rma","Eleme"], c:1},
      {q:"Kumlu suyu ayÄ±rma yÃ¶ntemi?", a:["SÃ¼zme","MÄ±knatÄ±s","DamÄ±tma"], c:0},
    ],
    "elektrik": [
      {q:"Seri devrede ampul sayÄ±sÄ± artarsa parlaklÄ±k genelde?", a:["Artar","AzalÄ±r","DeÄŸiÅŸmez"], c:1},
      {q:"Paralel devrede bir ampul patlarsa diÄŸerleri?", a:["SÃ¶ner","YanmayÄ± sÃ¼rdÃ¼rÃ¼r","Hepsi patlar"], c:1},
    ]
  };

  function tryMath(raw){
    let s = raw.toLowerCase()
      .replaceAll("Ã§arpÄ±","*").replaceAll("carpi","*").replaceAll("Ã—","*").replaceAll("x","*")
      .replaceAll("artÄ±","+").replaceAll("arti","+")
      .replaceAll("eksi","-")
      .replaceAll("bÃ¶lÃ¼","/").replaceAll("bolu","/").replaceAll("Ã·","/")
      .replaceAll(",",".");
    s = s.replace(/[^0-9+\-*/().\s]/g,"").trim();
    if(!s) return null;
    if(!(/\d/.test(s) && /[+\-*/]/.test(s))) return null;
    try{
      const v = Function('"use strict";return ('+s+')')();
      if(!isFinite(v)) return {text:"SonuÃ§ tanÄ±msÄ±z (0â€™a bÃ¶lme olabilir)."};
      const pretty = (Math.abs(v)%1===0) ? String(v) : String(Number(v.toFixed(6)));
      return {text:`SonuÃ§: ${pretty}\nÄ°ÅŸlem: ${s}`};
    }catch{ return null; }
  }

  function smartAnswer(conv, raw){
    const t = norm(raw);

    // âœ… TeÅŸekkÃ¼r / saÄŸol
    if (
      t.includes("tesekkur") || t.includes("teÅŸekkÃ¼r") ||
      t.includes("sagol") || t.includes("saÄŸol") ||
      t.includes("eyvallah") || t.includes("allah razi olsun") ||
      t === "tsk" || t === "tÅŸk" || t === "tÅŸekkÃ¼r"
    ){
      return { text: "Rica ederim, her zaman yanÄ±ndayÄ±m ðŸ¤" };
    }

    // Ä°sim kaydet
    const m = raw.match(/benim ad[Ä±i]m\s+(.+)/i);
    if(m && m[1]){
      state.userName = m[1].trim().replace(/[.!?]/g,"");
      saveAll();
      return {text:`Tamam ${state.userName} ðŸ˜Ž Ä°smini kaydettim.`};
    }

    // Test modu
    if(conv._test){
      const a = raw.trim().toUpperCase();
      const st = conv._test;
      if(t === "test iptal" || t === "iptal"){
        conv._test = null;
        return {text:"Test modunu kapattÄ±m âœ…"};
      }
      if(!["A","B","C"].includes(a)){
        return {text:`Test modundayÄ±z. Sadece A/B/C yaz.\n(Ã‡Ä±kmak iÃ§in: "test iptal")`};
      }
      const bank = MINI_TESTS[st.key];
      const q = bank[st.i];
      const idx = {A:0,B:1,C:2}[a];
      let out="";
      if(idx===q.c){ st.score++; out+="âœ… DoÄŸru!\n"; }
      else out+=`âŒ YanlÄ±ÅŸ. DoÄŸru: ${["A","B","C"][q.c]}\n`;

      st.i++;
      if(st.i >= bank.length){
        out += `\nTest bitti! Skor: ${st.score}/${bank.length}`;
        conv._test = null;
        return {text:out.trim()};
      }
      const nq = bank[st.i];
      out += `Soru ${st.i+1}: ${nq.q}\nA) ${nq.a[0]}\nB) ${nq.a[1]}\nC) ${nq.a[2]}\nCevap: A/B/C`;
      return {text:out.trim()};
    }

    if(t.startsWith("test:")){
      const key = norm(t.split("test:")[1]||"");
      let k=null;
      if(key.includes("karisim")) k="karisimlar";
      else if(key.includes("elektrik")) k="elektrik";
      else return {text:"Bu test yok. Deneyin: test: karÄ±ÅŸÄ±mlar / elektrik"};

      conv._test = {key:k, i:0, score:0};
      const q = MINI_TESTS[k][0];
      return {text:`Mini test baÅŸladÄ± (${key}).\nSoru 1: ${q.q}\nA) ${q.a[0]}\nB) ${q.a[1]}\nC) ${q.a[2]}\nCevap: A/B/C`};
    }

    // 7. sÄ±nÄ±f konular
    if(t.includes("7 sinif") && t.includes("konu")) return {text:listTopics()};

    // konu anlat
    if(t.startsWith("konu anlat:")){
      const topic = norm(raw.split(":")[1]||"");
      if(topic.includes("karisim")){
        return {text:`KarÄ±ÅŸÄ±mlar (Ã¶zet):
â€¢ Homojen: tuzlu su
â€¢ Heterojen: yaÄŸ-su, kumlu su
â€¢ AyÄ±rma: sÃ¼zme, eleme, mÄ±knatÄ±s, buharlaÅŸtÄ±rma
Ä°stersen: "test: karÄ±ÅŸÄ±mlar"`};
      }
      if(topic.includes("elektrik")){
        return {text:`Elektrik devreleri (Ã¶zet):
â€¢ KapalÄ± devre: yanar, aÃ§Ä±k devre: yanmaz
â€¢ Seri: tek yol, biri koparsa hepsi sÃ¶ner
â€¢ Paralel: kollar baÄŸÄ±msÄ±z
Ä°stersen: "test: elektrik"`};
      }
      return {text:"Konu baÅŸlÄ±ÄŸÄ±nÄ± biraz daha net yaz: 'Konu anlat: KarÄ±ÅŸÄ±mlar' gibi."};
    }

    // cumhuriyet
    if(t.includes("cumhuriyet")){
      if(t.includes("ne zaman") || t.includes("ilan")) return {text:`${REPUBLIC.proclamation}\n${REPUBLIC.republicDay}`};
      return {text:REPUBLIC.republicDay};
    }

    // gÃ¼nlÃ¼k
    if(t.includes("saat kac") || t.includes("saat kaÃ§")) return {text:`Åžu an saat: ${new Date().toLocaleTimeString("tr-TR")}`};
    if(t.includes("bugun") && (t.includes("gun") || t.includes("tarih"))) return {text:`BugÃ¼n: ${today()}`};

    // matematik
    const math = tryMath(raw);
    if(math) return math;

    // fallback => google
    return googleAnswerHTML(raw);
  }

  // UI refs
  const chatArea = $("chatArea");
  const inp = $("inp");
  const sendBtn = $("send");

  // Sidebar render helper (for both desktop & mobile)
  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleDateString("tr-TR",{month:"short", day:"2-digit"});
  }

  function renderTopbar(){
    const conv = getActive();
    $("topTitle").textContent = conv ? conv.title : state.appTitle;
  }

  function addRowDOM(who, text, tstamp, html){
    const row = document.createElement("div");
    row.className = "row";

    const av = document.createElement("div");
    av.className = "avatar " + (who==="me" ? "me":"bot");
    av.textContent = who==="me" ? "S" : "AI";

    const bub = document.createElement("div");
    bub.className = "bubble";
    if(html) bub.innerHTML = html.replace(/\n/g,"<br>");
    else bub.textContent = text;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = (who==="me" ? "Sen" : state.appTitle) + " â€¢ " + new Date(tstamp).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
    bub.appendChild(meta);

    row.appendChild(av);
    row.appendChild(bub);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function renderChat(){
    chatArea.innerHTML = "";
    const conv = getActive();
    if(!conv) return;

    if(conv.messages.length === 0){
      addRowDOM("bot",
`Selam! Ben ${state.appTitle} ðŸ˜Ž
â€¢ MenÃ¼ telefonda: sol Ã¼stte (â‰¡)
â€¢ "saÄŸol / teÅŸekkÃ¼r" yazÄ±nca Ã¶zel cevap
â€¢ bilmediÄŸim sorularda Google butonu

Denemek:
- "7. sÄ±nÄ±f konular"
- "Konu anlat: KarÄ±ÅŸÄ±mlar"
- "test: karÄ±ÅŸÄ±mlar"
- "telefonum neden yavaÅŸ"
- "teÅŸekkÃ¼r ederim"`, Date.now());
      return;
    }

    for(const m of conv.messages){
      addRowDOM(m.who, m.text, m.t, m.html);
    }
  }

  function renderChatList(listEl, searchValue){
    const q = norm(searchValue || "");
    listEl.innerHTML = "";

    const convsSorted = [...state.convs].sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
    const filtered = q ? convsSorted.filter(c => norm(c.title).includes(q)) : convsSorted;

    for(const c of filtered){
      const item = document.createElement("div");
      item.className = "chatItem" + (c.id === state.activeId ? " active" : "");
      item.onclick = () => { setActive(c.id); closeMobileMenu(); };

      const left = document.createElement("div");
      left.style.minWidth = "0px";

      const title = document.createElement("div");
      title.className = "chatTitle";
      title.textContent = c.title || "Sohbet";

      const meta = document.createElement("div");
      meta.className = "chatMeta";
      meta.textContent = `${fmtDate(c.updatedAt || c.createdAt)} â€¢ ${c.messages?.length || 0} mesaj`;

      left.appendChild(title);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "chatActions";

      const ren = document.createElement("button");
      ren.className = "iconBtn";
      ren.title = "Yeniden adlandÄ±r";
      ren.textContent = "âœŽ";
      ren.onclick = (e) => {
        e.stopPropagation();
        const name = prompt("Sohbet adÄ±:", c.title || "Yeni sohbet");
        if(name === null) return;
        c.title = (name || "").trim() || "Yeni sohbet";
        c.updatedAt = Date.now();
        saveAll();
        renderAll();
      };

      const del = document.createElement("button");
      del.className = "iconBtn red";
      del.title = "Sil";
      del.textContent = "ðŸ—‘";
      del.onclick = (e) => {
        e.stopPropagation();
        if(!confirm("Bu sohbet silinsin mi?")) return;
        state.convs = state.convs.filter(x => x.id !== c.id);
        if(state.activeId === c.id) state.activeId = state.convs[0]?.id || null;
        saveAll();
        ensureOneConversation();
        renderAll();
      };

      actions.appendChild(ren);
      actions.appendChild(del);

      item.appendChild(left);
      item.appendChild(actions);

      listEl.appendChild(item);
    }
  }

  function renderAll(){
    renderTopbar();
    renderChat();
    renderChatList($("chatListD"), $("sbSearchD").value);
    renderChatList($("chatListM"), $("sbSearchM").value);
  }

  // Typing row
  function addTypingRow(){
    const row = document.createElement("div");
    row.className = "row";
    row.id = "typingRow";

    const av = document.createElement("div");
    av.className = "avatar bot";
    av.textContent = "AI";

    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.innerHTML = `<span class="typing">${state.appTitle} yazÄ±yor <span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${state.appTitle} â€¢ ${now()}`;
    bub.appendChild(meta);

    row.appendChild(av);
    row.appendChild(bub);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function removeTypingRow(){
    const t = document.getElementById("typingRow");
    if(t) t.remove();
  }

  function autoResize(){
    inp.style.height = "0px";
    inp.style.height = Math.min(inp.scrollHeight, 160) + "px";
  }

  async function send(){
    const text = inp.value.trim();
    if(!text) return;
    const conv = getActive();
    if(!conv) return;

    inp.value = "";
    autoResize();
    sendBtn.disabled = true;

    conv.messages.push({who:"me", text, t:Date.now()});
    conv.updatedAt = Date.now();
    if(conv.title === "Yeni sohbet"){
      conv.title = text.slice(0, 28) + (text.length>28 ? "â€¦" : "");
    }
    saveAll();
    renderAll();

    addTypingRow();

    const ans = smartAnswer(conv, text);

    setTimeout(async () => {
      removeTypingRow();

      const row = document.createElement("div");
      row.className = "row";

      const av = document.createElement("div");
      av.className = "avatar bot";
      av.textContent = "AI";

      const bub = document.createElement("div");
      bub.className = "bubble";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${state.appTitle} â€¢ ${now()}`;

      row.appendChild(av);
      row.appendChild(bub);
      chatArea.appendChild(row);
      chatArea.scrollTop = chatArea.scrollHeight;

      const html = ans.html ? ans.html : (ans.text || "");
      await typewriter(bub, html, 12);
      bub.appendChild(meta);

      conv.messages.push({who:"bot", text:(ans.text||""), html:(ans.html||null), t:Date.now()});
      conv.updatedAt = Date.now();
      saveAll();
      renderAll();

      sendBtn.disabled = false;
      inp.focus();
    }, 320);
  }

  // Actions
  function newChat(){
    const id = uid();
    state.convs.unshift({
      id,
      title:"Yeni sohbet",
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages: [],
      _test: null
    });
    state.activeId = id;
    saveAll();
    renderAll();
    closeMobileMenu();
  }

  function clearActiveChat(){
    const conv = getActive();
    if(!conv) return;
    if(!confirm("Bu sohbetin iÃ§i temizlensin mi?")) return;
    conv.messages = [];
    conv._test = null;
    conv.updatedAt = Date.now();
    saveAll();
    renderAll();
  }

  function renameActiveChat(){
    const conv = getActive();
    if(!conv) return;
    const name = prompt("Sohbet adÄ±:", conv.title || "Yeni sohbet");
    if(name === null) return;
    conv.title = (name || "").trim() || "Yeni sohbet";
    conv.updatedAt = Date.now();
    saveAll();
    renderAll();
  }

  function wipeAll(){
    if(!confirm("TÃœM sohbetler silinsin mi?")) return;
    state.convs = [];
    state.activeId = null;
    saveAll();
    ensureOneConversation();
    renderAll();
    closeMobileMenu();
  }

  function setUserName(){
    const n = prompt("AdÄ±n ne? (Ã–rn: Mehmet)", state.userName || "");
    if(n === null) return;
    state.userName = (n||"").trim();
    saveAll();
    alert(state.userName ? `Tamam ${state.userName} ðŸ™‚` : "Ä°sim temizlendi.");
  }

  // Wire buttons (Desktop + Mobile)
  $("newChatBtnD").onclick = newChat;
  $("newChatBtnM").onclick = newChat;

  $("wipeAllBtnD").onclick = wipeAll;
  $("wipeAllBtnM").onclick = wipeAll;

  $("btnNameD").onclick = setUserName;
  $("btnNameM").onclick = setUserName;

  $("btnHelpD").onclick = () => {
    const conv = getActive(); if(!conv) return;
    conv.messages.push({who:"bot", text:`Komutlar:
â€¢ "Benim adÄ±m ..." â†’ isim kaydeder
â€¢ "7. sÄ±nÄ±f konular"
â€¢ "Konu anlat: KarÄ±ÅŸÄ±mlar"
â€¢ "test: karÄ±ÅŸÄ±mlar" / "test: elektrik"
â€¢ "cumhuriyet ne zaman ilan edildi"
â€¢ "saÄŸol / teÅŸekkÃ¼r" â†’ Ã¶zel cevap
â€¢ bilmezsem Google butonu`, t:Date.now()});
    conv.updatedAt = Date.now();
    saveAll(); renderAll();
  };
  $("btnHelpM").onclick = $("btnHelpD").onclick;

  $("btnTopicsD").onclick = () => {
    const conv = getActive(); if(!conv) return;
    conv.messages.push({who:"bot", text:listTopics(), t:Date.now()});
    conv.updatedAt = Date.now();
    saveAll(); renderAll();
  };
  $("btnTopicsM").onclick = $("btnTopicsD").onclick;

  $("sbSearchD").addEventListener("input", () => renderChatList($("chatListD"), $("sbSearchD").value));
  $("sbSearchM").addEventListener("input", () => renderChatList($("chatListM"), $("sbSearchM").value));

  $("renameBtn").onclick = renameActiveChat;
  $("clearBtn").onclick = clearActiveChat;

  document.querySelectorAll("[data-q]").forEach(ch => {
    ch.addEventListener("click", () => {
      inp.value = ch.getAttribute("data-q");
      autoResize(); inp.focus();
      closeMobileMenu();
    });
  });

  $("send").onclick = send;
  inp.addEventListener("input", autoResize);
  inp.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // Init
  ensureOneConversation();
  renderAll();
  autoResize();
})();
</script>
</body>
</html>
