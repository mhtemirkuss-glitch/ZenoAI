<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZenoAI</title>

  <!-- PWA (opsiyonel, istersen sonra ekleriz) -->
  <!-- <link rel="manifest" href="manifest.json"> -->

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2e;
      --panel2:#0b162b;
      --text:#e8eefc;
      --muted:#9fb1d6;
      --border:rgba(255,255,255,.08);
      --accent:#7c3aed;
      --accent2:#22c55e;
      --bubbleUser:#1f3a8a;
      --bubbleBot:#172554;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(124,58,237,.35), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }

    /* Layout */
    .app{
      height:100%;
      display:grid;
      grid-template-rows: 64px 1fr;
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      border-bottom:1px solid var(--border);
      background: rgba(8,12,22,.55);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 220px;
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,1));
      display:grid; place-items:center;
      box-shadow: 0 10px 25px rgba(124,58,237,.25);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);
      transform: rotate(25deg);
      animation: shine 3.2s linear infinite;
    }
    @keyframes shine{
      0%{transform: translateX(-80%) rotate(25deg)}
      100%{transform: translateX(80%) rotate(25deg)}
    }
    .logo span{
      font-weight:900; letter-spacing:.5px;
      color:#06101f;
      text-shadow:none;
    }
    .titleWrap{
      display:flex; flex-direction:column; line-height:1.05;
    }
    .title{
      font-weight:800;
      letter-spacing:.3px;
      font-size:14px;
      opacity:.98;
    }
    .subtitle{
      font-size:12px; color:var(--muted);
    }

    .top-actions{
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius:999px;
      color:var(--text);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:.15s ease;
    }
    .pill:hover{ transform: translateY(-1px); background: rgba(255,255,255,.06); }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: var(--accent2);
      box-shadow: 0 0 0 4px rgba(34,197,94,.15);
    }

    /* Main */
    .main{
      display:grid;
      grid-template-columns: 320px 1fr 360px;
      gap:12px;
      padding:12px;
      min-height:0;
    }
    .card{
      background: rgba(15,26,46,.72);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      min-height:0;
      overflow:hidden;
    }
    .cardHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between;
      background: rgba(8,12,22,.25);
    }
    .cardHeader h3{
      margin:0;
      font-size:13px;
      color: var(--text);
      letter-spacing:.3px;
    }

    /* Sidebar menu */
    .menu{
      padding:10px;
      display:flex; flex-direction:column;
      gap:8px;
      overflow:auto;
    }
    .menuBtn{
      display:flex; align-items:center; gap:10px;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      transition:.15s ease;
      font-size:13px;
      color: var(--text);
    }
    .menuBtn:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .menuBtn.active{
      border-color: rgba(124,58,237,.55);
      background: rgba(124,58,237,.15);
    }
    .menuIcon{
      width:26px;height:26px;border-radius:10px;
      display:grid;place-items:center;
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      font-weight:700;
      color: var(--muted);
    }
    .menuSmall{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.12);
      color: var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .menuSmall code{color:#c7d2fe}

    /* Chat area */
    .chat{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .messages{
      padding:14px;
      overflow:auto;
      min-height:0;
    }
    .msg{
      display:flex;
      margin-bottom:10px;
    }
    .msg.user{ justify-content:flex-end; }
    .bubble{
      max-width: 78%;
      padding:10px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      line-height:1.35;
      font-size:13px;
      white-space:pre-wrap;
      word-wrap:break-word;
    }
    .user .bubble{
      background: linear-gradient(180deg, rgba(31,58,138,.55), rgba(31,58,138,.35));
    }
    .bot .bubble{
      background: linear-gradient(180deg, rgba(23,37,84,.55), rgba(23,37,84,.35));
    }
    .meta{
      font-size:11px;
      color: rgba(159,177,214,.85);
      margin-top:4px;
    }

    .composer{
      padding:12px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      background: rgba(8,12,22,.25);
    }
    .input{
      flex:1;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      outline:none;
    }
    .btn{
      border:none;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,197,94,1));
      color:#07101f;
      font-weight:800;
      padding:10px 14px;
      border-radius:14px;
      cursor:pointer;
      transition:.15s ease;
      min-width:96px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    /* Right panel: quick prompts + settings */
    .right{
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .quick{
      padding:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      overflow:auto;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      transition:.15s ease;
      user-select:none;
    }
    .chip:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
    .section{
      padding:10px 12px;
      border-top:1px solid var(--border);
      overflow:auto;
    }
    .label{ font-size:12px; color:var(--muted); margin-bottom:6px; }
    .field{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      margin-bottom:10px;
    }
    .hint{
      font-size:12px;
      color: rgba(159,177,214,.9);
      line-height:1.4;
    }
    .danger{
      margin-top:10px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn2{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:9px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .main{ grid-template-columns: 300px 1fr; }
      .right{ display:none; }
    }
    @media (max-width: 820px){
      .main{ grid-template-columns: 1fr; }
      .card.sidebar{ display:none; }
      .topbar{ gap:10px; }
      .brand{ min-width:auto; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" title="ZenoAI"><span>Z</span></div>
        <div class="titleWrap">
          <div class="title" id="appTitle">ZenoAI</div>
          <div class="subtitle" id="appSubtitle">Mehmet Emir AI ‚Ä¢ Sohbet + Bilgi</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="statusPill" title="Baƒülantƒ± durumu">
          <span class="dot" id="statusDot"></span>
          <span id="statusText">Offline Mod</span>
        </div>
        <div class="pill" id="menuToggle" title="Men√º (mobil)">
          ‚ò∞ Men√º
        </div>
      </div>
    </div>

    <div class="main">
      <!-- LEFT: Menu -->
      <div class="card sidebar" id="sidebarCard">
        <div class="cardHeader">
          <h3>Men√º</h3>
          <span style="font-size:12px;color:var(--muted)">ZenoAI</span>
        </div>
        <div class="menu" id="menu">
          <div class="menuBtn active" data-mode="chat">
            <div class="menuIcon">üí¨</div> Sohbet
          </div>
          <div class="menuBtn" data-mode="grade7">
            <div class="menuIcon">7</div> 7. Sƒ±nƒ±f
          </div>
          <div class="menuBtn" data-mode="history">
            <div class="menuIcon">üèõÔ∏è</div> Tarih
          </div>
          <div class="menuBtn" data-mode="daily">
            <div class="menuIcon">‚òÄÔ∏è</div> G√ºnl√ºk
          </div>
          <div class="menuBtn" data-mode="settings">
            <div class="menuIcon">‚öôÔ∏è</div> Ayarlar
          </div>

          <div class="menuSmall">
            Komut √∂rnekleri:
            <br>‚Ä¢ <code>Konu anlat: Karƒ±≈üƒ±mlar</code>
            <br>‚Ä¢ <code>test: karƒ±≈üƒ±mlar</code>
            <br>‚Ä¢ <code>osmanlƒ±nƒ±n 2. padi≈üahƒ±</code>
            <br>‚Ä¢ <code>12 b√∂l√º 3</code>
          </div>
        </div>
      </div>

      <!-- CENTER: Chat -->
      <div class="card chat">
        <div class="cardHeader">
          <h3 id="modeTitle">Sohbet</h3>
          <span style="font-size:12px;color:var(--muted)" id="modeHint">Sorunu yaz, ben cevaplayayƒ±m.</span>
        </div>

        <div class="messages" id="messages"></div>

        <div class="composer">
          <input class="input" id="input" placeholder='Bir ≈üey yaz... (√∂rn: "istanbulu kim fethetti")' />
          <button class="btn" id="sendBtn">G√∂nder</button>
        </div>
      </div>

      <!-- RIGHT: Quick / Settings -->
      <div class="card right">
        <div class="cardHeader"><h3>Hƒ±zlƒ± Denemeler</h3></div>
        <div class="quick" id="quick"></div>

        <div class="section">
          <div class="label">Ba≈ülƒ±k / ƒ∞sim</div>
          <input class="field" id="nameInput" placeholder="Mehmet Emir AI" value="Mehmet Emir AI" />
          <div class="label">Ger√ßek AI (API) ‚Äî opsiyonel</div>
          <input class="field" id="apiUrl" placeholder="https://SENIN-WORKER-ADRESIN.workers.dev/api/chat" />
          <input class="field" id="apiKey" placeholder="API Key (istersen)" type="password" />
          <div class="hint">
            ‚ö†Ô∏è GitHub Pages ‚Äúsadece statik‚Äù olduƒüu i√ßin ger√ßek AI baƒülantƒ±sƒ± i√ßin genelde
            <b>Cloudflare Worker / kendi sunucun</b> gerekir. (ƒ∞stersen 2 dakikada kurarƒ±z.)
          </div>

          <div class="danger">
            <button class="btn2" id="clearBtn">Sohbeti Temizle</button>
            <button class="btn2" id="demoBtn">Demo Mesajƒ±</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   ZenoAI ‚Äî Offline ‚ÄúMini Brain‚Äù + (opsiyonel) Online AI
   Tek dosya index.html ‚Äî GitHub Pages uyumlu.
========================================================= */

// ---------- UI helpers ----------
const $ = (id)=>document.getElementById(id);
const messagesEl = $("messages");
const inputEl = $("input");
const sendBtn = $("sendBtn");
const modeTitleEl = $("modeTitle");
const modeHintEl = $("modeHint");
const statusTextEl = $("statusText");
const statusDotEl = $("statusDot");
const sidebarCard = $("sidebarCard");
const menuToggle = $("menuToggle");

// ---------- state ----------
let MODE = "chat"; // chat | grade7 | history | daily | settings
let DISPLAY_NAME = "Mehmet Emir AI";

function nowTime(){
  const d = new Date();
  return d.toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
}

function addMessage(role, text){
  const wrap = document.createElement("div");
  wrap.className = "msg " + (role==="user" ? "user":"bot");

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = (role==="user" ? "Sen" : DISPLAY_NAME) + " ‚Ä¢ " + nowTime();

  const holder = document.createElement("div");
  holder.style.display = "flex";
  holder.style.flexDirection = "column";
  holder.style.alignItems = role==="user" ? "flex-end":"flex-start";
  holder.appendChild(bubble);
  holder.appendChild(meta);

  wrap.appendChild(holder);
  messagesEl.appendChild(wrap);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function setMode(newMode){
  MODE = newMode;
  const titles = {
    chat: ["Sohbet", "Sorunu yaz, ben cevaplayayƒ±m."],
    grade7: ["7. Sƒ±nƒ±f", "Konu anlat / test modunu deneyebilirsin."],
    history: ["Tarih", "Osmanlƒ±, Cumhuriyet, genel tarih sor."],
    daily: ["G√ºnl√ºk", "G√ºnl√ºk hayatta sorulan sorularƒ± sor."],
    settings: ["Ayarlar", "ƒ∞sim ve AI baƒülantƒ±sƒ± (opsiyonel)."]
  };
  const [t,h] = titles[newMode] || titles.chat;
  modeTitleEl.textContent = t;
  modeHintEl.textContent = h;

  // Men√ºy√º aktive et
  document.querySelectorAll(".menuBtn").forEach(btn=>{
    btn.classList.toggle("active", btn.dataset.mode===newMode);
  });

  // Hƒ±zlƒ± denemeleri g√ºncelle
  renderQuick();
}

function setOnlineStatus(isOnline){
  if(isOnline){
    statusTextEl.textContent = "Online (Opsiyonel)";
    statusDotEl.style.background = "var(--accent2)";
  }else{
    statusTextEl.textContent = "Offline Mod";
    statusDotEl.style.background = "var(--accent)";
    statusDotEl.style.boxShadow = "0 0 0 4px rgba(124,58,237,.15)";
  }
}

// ---------- Quick prompts ----------
function renderQuick(){
  const quickEl = $("quick");
  if(!quickEl) return;
  quickEl.innerHTML = "";

  const sets = {
    chat: [
      "Benim adƒ±m Mehmet",
      "istanbulu hangi padi≈üah fethetti",
      "12 b√∂l√º 3",
      "Konu anlat: Karƒ±≈üƒ±mlar",
      "test: karƒ±≈üƒ±mlar",
      "Te≈üekk√ºrler"
    ],
    grade7: [
      "7. sƒ±nƒ±f konular",
      "Konu anlat: Elektrik Devreleri",
      "Konu anlat: Karƒ±≈üƒ±mlar",
      "Konu anlat: H√ºcre ve B√∂l√ºnmeler",
      "test: elektrik devreleri",
      "test: karƒ±≈üƒ±mlar"
    ],
    history: [
      "osmanlƒ±nƒ±n 2. padi≈üahƒ± kim",
      "osmanlƒ±nƒ±n 4. padi≈üahƒ± kim",
      "Fatih Sultan Mehmet nasƒ±l √∂ld√º",
      "Cumhuriyet ne zaman ilan edildi",
      "TBMM ne zaman a√ßƒ±ldƒ±"
    ],
    daily: [
      "Bug√ºn ne yesem?",
      "Uyku d√ºzeni nasƒ±l d√ºzelir?",
      "Telefon yava≈üladƒ± ne yapayƒ±m?",
      "Motivasyonum yok ne yapayƒ±m?",
      "Te≈üekk√ºr ederim"
    ],
    settings: [
      "ƒ∞sim deƒüi≈ütir",
      "API baƒüla",
      "Siteyi test et"
    ]
  };

  (sets[MODE] || sets.chat).forEach(t=>{
    const chip = document.createElement("div");
    chip.className="chip";
    chip.textContent=t;
    chip.onclick=()=>{ inputEl.value=t; inputEl.focus(); };
    quickEl.appendChild(chip);
  });
}

// ---------- Mini Knowledge Base (offline) ----------
const KB = {
  thanks: [
    "saƒüol","saol","te≈üekk√ºr","tesekk√ºr","t≈ük","eyvallah","thanks","thx"
  ],
  greetings: [
    "selam","merhaba","slm","hey","naber","nasƒ±lsƒ±n","nasilsin"
  ],

  // Osmanlƒ± padi≈üahlarƒ± (mini √∂rnek ‚Äî istersen geni≈ületiriz)
  ottoman: [
    {n:1, name:"Osman Gazi", death:"Doƒüal nedenler (1324 civarƒ±)"},
    {n:2, name:"Orhan Gazi", death:"Doƒüal nedenler (1362)"},
    {n:3, name:"I. Murad (H√ºdavendig√¢r)", death:"Kosova Sava≈üƒ± sonrasƒ± suikast/√∂ld√ºr√ºld√º (1389)"},
    {n:4, name:"Yƒ±ldƒ±rƒ±m Bayezid", death:"Esaret sonrasƒ± (1403) ‚Äî kaynaklarda hastalƒ±k/zehirlenme tartƒ±≈ümalƒ±"},
    {n:7, name:"II. Mehmed (Fatih)", death:"1481 ‚Äî hastalƒ±k (bazƒ± kaynaklarda zehirlenme iddiasƒ± vardƒ±r)"},
    {n:10, name:"Kanuni Sultan S√ºleyman", death:"1566 ‚Äî Zigetvar Seferi sƒ±rasƒ±nda hastalƒ±k"}
  ],

  republic: [
    {q:/cumhuriyet ne zaman ilan edildi/i, a:"T√ºrkiye Cumhuriyeti 29 Ekim 1923‚Äôte ilan edildi."},
    {q:/tbmm ne zaman a√ßƒ±ldƒ±/i, a:"TBMM 23 Nisan 1920‚Äôde a√ßƒ±ldƒ±."}
  ],

  // 7. sƒ±nƒ±f √∂rnek konu √∂zetleri (mini)
  grade7Topics: [
    {key:"karƒ±≈üƒ±mlar", title:"Karƒ±≈üƒ±mlar", text:
`Karƒ±≈üƒ±mlar, iki veya daha fazla maddenin kimyasal baƒü yapmadan bir araya gelmesidir.
‚Ä¢ Homojen karƒ±≈üƒ±m: Her yerde aynƒ± (√ß√∂zelti) ‚Äî tuzlu su, ≈üekerli su
‚Ä¢ Heterojen karƒ±≈üƒ±m: Her yerde aynƒ± deƒüil ‚Äî kumlu su, ayran
Ayƒ±rma y√∂ntemleri: s√ºzme, buharla≈ütƒ±rma, mƒ±knatƒ±sla ayƒ±rma, eleme, damƒ±tma.`},
    {key:"elektrik devreleri", title:"Elektrik Devreleri", text:
`Basit devre: Pil + iletken kablo + ampul + anahtar.
‚Ä¢ Seri baƒülama: Akƒ±m her elemandan aynƒ± ge√ßer, bir ampul patlarsa hepsi s√∂ner.
‚Ä¢ Paralel baƒülama: Gerilim kollar arasƒ±nda aynƒ±dƒ±r, bir ampul patlarsa diƒüerleri yanar.`},
    {key:"h√ºcre ve b√∂l√ºnmeler", title:"H√ºcre ve B√∂l√ºnmeler", text:
`‚Ä¢ Mitoz: B√ºy√ºme/onarƒ±m; 1 h√ºcre ‚Üí 2 aynƒ± h√ºcre.
‚Ä¢ Mayoz: √úreme ana h√ºcrelerinde; 1 h√ºcre ‚Üí 4 farklƒ± h√ºcre; kromozom sayƒ±sƒ± yarƒ±ya iner.`}
  ],

  dailyFAQ: [
    {q:/telefon.*yava≈ü/i, a:
`Telefon yava≈üladƒ±ysa hƒ±zlƒ± √ß√∂z√ºmler:
1) Depolama bo≈üalt (en az %15 bo≈ü kalsƒ±n)
2) Gereksiz uygulamalarƒ± kaldƒ±r
3) Arka plandaki uygulamalarƒ± kapat
4) G√ºncelleme var mƒ± kontrol et
5) Yeniden ba≈ülat`},
    {q:/uyku.*d√ºzen/i, a:
`Uyku d√ºzeni i√ßin:
‚Ä¢ Her g√ºn aynƒ± saatte yat-kalk
‚Ä¢ Yatmadan 1 saat √∂nce ekranƒ± azalt
‚Ä¢ Ak≈üam kafein alma
‚Ä¢ Odayƒ± serin/karanlƒ±k tut
‚Ä¢ G√ºnd√ºz kƒ±sa y√ºr√ºy√º≈ü iyi gelir`},
    {q:/bug√ºn ne yesem|ne yesek/i, a:
`Hƒ±zlƒ± √∂neri:
‚Ä¢ Tavuk + salata
‚Ä¢ Mercimek √ßorbasƒ± + yoƒüurt
‚Ä¢ Makarna + ton balƒ±ƒüƒ±
‚Ä¢ Omlet + peynir + zeytin
ƒ∞stersen evde ne var yaz, ona g√∂re men√º √ßƒ±karayƒ±m.`}
  ]
};

// ---------- Core answer logic (offline) ----------
function normalize(s){
  return (s||"")
    .toLowerCase()
    .replaceAll("ƒ±","i").replaceAll("ƒü","g").replaceAll("≈ü","s")
    .replaceAll("√∂","o").replaceAll("√º","u").replaceAll("√ß","c")
    .trim();
}

function isThanks(text){
  const t = normalize(text);
  return KB.thanks.some(w=>t.includes(normalize(w)));
}

function isGreeting(text){
  const t = normalize(text);
  return KB.greetings.some(w=>t.includes(normalize(w)));
}

function tryMath(text){
  // basit "12 b√∂l√º 3" / "12/3" / "12 √∑ 3" / "12 * 3"
  const t = normalize(text)
    .replaceAll("bolu","/").replaceAll("b√∂l√º","/")
    .replaceAll("x","*").replaceAll("√∑","/")
    .replaceAll(",",".");

  // sadece g√ºvenli karakterler varsa hesapla
  const safe = t.match(/^[0-9\s\.\+\-\*\/\(\)]+$/);
  if(!safe) return null;

  try{
    // eslint-disable-next-line no-new-func
    const val = Function("return (" + t + ")")();
    if(typeof val === "number" && isFinite(val)){
      return `Sonu√ß: ${val}`;
    }
  }catch(e){}
  return null;
}

function tryOttoman(text){
  const t = normalize(text);

  // "osmanlƒ±nƒ±n 2. padi≈üahƒ±"
  let m = t.match(/osmanli(nin)?\s*([0-9]+)\.?\s*p(adisah|adisahi)/i);
  if(m){
    const num = parseInt(m[2],10);
    const item = KB.ottoman.find(x=>x.n===num);
    if(item) return `Osmanlƒ±‚Äônƒ±n ${num}. padi≈üahƒ±: ${item.name}.`;
    return `Bu listemde ≈üu an ${num}. padi≈üah yok. ƒ∞stersen t√ºm listeyi geni≈ületelim.`;
  }

  // "fatih sultan mehmet nasƒ±l √∂ld√º"
  if(t.includes("fatih") && (t.includes("nasil oldu") || t.includes("nasƒ±l oldu") || t.includes("oldu") || t.includes("oldu") || t.includes("oldu") || t.includes("oldu"))){
    const item = KB.ottoman.find(x=>x.n===7);
    return `${item.name} (${item.n}. padi≈üah) ‚Äî √ñl√ºm√º: ${item.death}.`;
  }

  // "istanbulu hangi padi≈üah fethetti"
  if(t.includes("istanbul") && (t.includes("kim fethetti") || t.includes("hangi padisah fethetti"))){
    return "ƒ∞stanbul‚Äôu fetheden padi≈üah: II. Mehmed (Fatih Sultan Mehmet) ‚Äî 1453.";
  }

  return null;
}

function tryGrade7(text){
  const t = normalize(text);

  if(t === "7. sinif konular" || t === "7. sƒ±nƒ±f konular" || t.includes("7. sinif konular")){
    const list = KB.grade7Topics.map(x=>`‚Ä¢ ${x.title}`).join("\n");
    return `7. Sƒ±nƒ±f (≈üimdilik ekli olan √∂rnek konular):\n${list}\n\nKonu anlatmak i√ßin: "Konu anlat: Karƒ±≈üƒ±mlar" gibi yaz.`;
  }

  // "Konu anlat: ..."
  const m = text.match(/Konu anlat:\s*(.+)/i);
  if(m){
    const key = normalize(m[1]);
    const item = KB.grade7Topics.find(x=>normalize(x.key)===key || normalize(x.title)===key);
    if(item) return `${item.title}\n\n${item.text}`;
    return `Bu konuyu hen√ºz eklemedim: "${m[1]}". ƒ∞stersen ekleyelim.`;
  }

  // "test: ..."
  const tm = text.match(/test:\s*(.+)/i);
  if(tm){
    const key = normalize(tm[1]);
    if(key.includes("karisim")){
      return `Mini Test ‚Äî Karƒ±≈üƒ±mlar
1) Tuzlu su nasƒ±l bir karƒ±≈üƒ±mdƒ±r? (Homojen / Heterojen)
2) Kumlu suyu ayƒ±rmak i√ßin hangi y√∂ntem uygundur?
3) Damƒ±tma ne i√ßin kullanƒ±lƒ±r?

Cevap anahtarƒ± istersen: "test: karƒ±≈üƒ±mlar cevap" yaz.`;
    }
    if(key.includes("elektrik")){
      return `Mini Test ‚Äî Elektrik Devreleri
1) Seri baƒülƒ± devrede bir ampul patlarsa ne olur?
2) Paralel baƒülamanƒ±n avantajƒ± nedir?
3) Anahtarƒ±n g√∂revi nedir?`;
    }
    return `Test modunda ≈üu an bu konu yok: "${tm[1]}".`;
  }

  if(t.includes("test") && t.includes("cevap")){
    if(t.includes("karisim")){
      return `Cevap Anahtarƒ± ‚Äî Karƒ±≈üƒ±mlar
1) Homojen
2) S√ºzme
3) Sƒ±vƒ± karƒ±≈üƒ±mlarƒ± kaynama noktasƒ± farkƒ±yla ayƒ±rma (√∂r: saf su elde etme).`;
    }
  }

  return null;
}

function tryRepublic(text){
  for(const it of KB.republic){
    if(it.q.test(text)) return it.a;
  }
  return null;
}

function tryDaily(text){
  for(const it of KB.dailyFAQ){
    if(it.q.test(text)) return it.a;
  }
  return null;
}

function offlineAnswer(text){
  if(!text || !text.trim()) return "Bir ≈üey yazarsan cevaplayayƒ±m üôÇ";

  if(isThanks(text)){
    return "Rica ederim, her zaman yanƒ±ndayƒ±m ü§ù";
  }

  if(isGreeting(text)){
    return `Selam! Ben ${DISPLAY_NAME} üòé ƒ∞stersen ‚ÄúBenim adƒ±m ...‚Äù yaz, adƒ±nƒ± hatƒ±rlayayƒ±m.`;
  }

  // MODE bazlƒ± √∂ncelikler
  if(MODE==="grade7"){
    return tryGrade7(text) || tryMath(text) || "Bu soruyu 7. sƒ±nƒ±f formatƒ±nda biraz daha net yazar mƒ±sƒ±n? (Konu anlat / test / i≈ülem)";
  }
  if(MODE==="history"){
    return tryOttoman(text) || tryRepublic(text) || "Tarih sorunu biraz daha net yaz: (Osmanlƒ± / Cumhuriyet / olay / tarih)";
  }
  if(MODE==="daily"){
    return tryDaily(text) || "G√ºnl√ºk sorunu biraz daha a√ß: (hedefin ne, hangi ≈üartlarda?)";
  }
  if(MODE==="settings"){
    return "Ayarlar men√ºs√ºndesin. Saƒüdan ismini deƒüi≈ütirebilir veya API baƒülantƒ±sƒ± ekleyebilirsin.";
  }

  // Genel mod
  return (
    tryOttoman(text) ||
    tryRepublic(text) ||
    tryGrade7(text) ||
    tryDaily(text) ||
    tryMath(text) ||
    "Bunu offline modda tam √ßƒ±karamadƒ±m. ƒ∞stersen ‚ÄòGer√ßek AI‚Äô baƒülayalƒ±m: saƒüdaki API alanƒ±na adresini girince daha akƒ±llƒ± olur."
  );
}

// ---------- Optional Online AI call ----------
async function callOnlineAI(userText){
  const url = $("apiUrl")?.value?.trim();
  const key = $("apiKey")?.value?.trim();

  if(!url) return null;

  try{
    const res = await fetch(url, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        ...(key ? {"Authorization":"Bearer " + key} : {})
      },
      body: JSON.stringify({
        message: userText,
        mode: MODE,
        name: DISPLAY_NAME
      })
    });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    // Beklenen cevap: { reply: "..." }
    if(data && data.reply) return String(data.reply);
    return null;
  }catch(e){
    return null;
  }
}

// ---------- Send flow ----------
async function handleSend(){
  const text = inputEl.value.trim();
  if(!text) return;
  inputEl.value="";
  addMessage("user", text);
  sendBtn.disabled = true;

  // √ñnce offline cevapla (hƒ±zlƒ±)
  let reply = offlineAnswer(text);

  // Online varsa dene (bulamazsa offline kalsƒ±n)
  const online = await callOnlineAI(text);
  if(online) reply = online;

  addMessage("bot", reply);
  sendBtn.disabled = false;
  inputEl.focus();
}

// ---------- Init ----------
function boot(){
  // first message
  addMessage("bot", `Selam! Ben ${DISPLAY_NAME} üòé
Men√ºden mod se√ßebilirsin: Sohbet / 7. Sƒ±nƒ±f / Tarih / G√ºnl√ºk.

√ñrnek:
‚Ä¢ "istanbulu hangi padi≈üah fethetti"
‚Ä¢ "Konu anlat: Karƒ±≈üƒ±mlar"
‚Ä¢ "12 b√∂l√º 3"`);

  setMode("chat");
  setOnlineStatus(false);

  // menu click
  document.querySelectorAll(".menuBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      setMode(btn.dataset.mode);
    });
  });

  // send handlers
  sendBtn.addEventListener("click", handleSend);
  inputEl.addEventListener("keydown", (e)=>{
    if(e.key==="Enter") handleSend();
  });

  // name live update
  const nameInput = $("nameInput");
  if(nameInput){
    nameInput.addEventListener("input", ()=>{
      DISPLAY_NAME = nameInput.value.trim() || "Mehmet Emir AI";
      $("appSubtitle").textContent = DISPLAY_NAME + " ‚Ä¢ Sohbet + Bilgi";
    });
  }

  // demo
  $("demoBtn")?.addEventListener("click", ()=>{
    inputEl.value = "istanbulu hangi padi≈üah fethetti";
    handleSend();
  });

  // clear
  $("clearBtn")?.addEventListener("click", ()=>{
    messagesEl.innerHTML = "";
    bootHelloOnly();
  });

  // online indicator watcher
  setInterval(()=>{
    const url = $("apiUrl")?.value?.trim();
    setOnlineStatus(!!url);
  }, 900);

  // mobile menu toggle (show/hide sidebar)
  menuToggle?.addEventListener("click", ()=>{
    if(sidebarCard.style.display==="none"){
      sidebarCard.style.display="block";
    }else{
      sidebarCard.style.display="none";
    }
  });

  // default display name
  $("appSubtitle").textContent = DISPLAY_NAME + " ‚Ä¢ Sohbet + Bilgi";
}

function bootHelloOnly(){
  addMessage("bot", `Sohbet temizlendi ‚úÖ
Ben ${DISPLAY_NAME}. Ne soracaksƒ±n?`);
}

boot();
</script>
</body>
</html>
