<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mehmet Emir AI</title>

  <style>
    :root{
      --bg:#343541;
      --panel:#40414f;
      --panel2:#202123;
      --side:#111214;
      --side2:#0c0d0f;
      --text:#ececf1;
      --muted:#c5c5d2;
      --border:rgba(255,255,255,.12);
      --green:#19c37d;
      --danger:#ff4d4d;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:#8ad0ff}
    .app{
      display:grid;
      grid-template-columns: 300px 1fr;
      min-height:100vh;
    }

    /* Sidebar */
    .sidebar{
      background:linear-gradient(180deg,var(--side),var(--side2));
      border-right:1px solid rgba(255,255,255,.08);
      display:flex;
      flex-direction:column;
      padding:12px;
      gap:10px;
    }
    .sbTop{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .brand{
      display:flex;gap:10px;align-items:center;min-width:0;
    }
    .logoBox{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, var(--green), #7aa7ff, #b36bff);
      background-size: 220% 220%;
      animation: glowMove 6s linear infinite;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      flex:0 0 auto;
    }
    .logoBox span{
      font-weight:1000; letter-spacing:.5px;
      color:#07110a; font-size:14px;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    @keyframes glowMove{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    .brandText{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brandText b{
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      background: linear-gradient(90deg,#e7e7ff,#8ad0ff,#e7e7ff);
      background-size: 200% 100%;
      -webkit-background-clip:text;
      color:transparent;
      animation: titleShine 5s linear infinite;
    }
    @keyframes titleShine{
      0%{background-position:0%}
      100%{background-position:200%}
    }
    .brandText small{
      color:rgba(197,197,210,.85);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .sbBtn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .sbBtn:hover{background:rgba(255,255,255,.10)}
    .sbBtn.green{border-color:rgba(25,195,125,.55); background:rgba(25,195,125,.12)}
    .sbBtn.danger{border-color:rgba(255,77,77,.45); background:rgba(255,77,77,.10)}
    .sbTools{display:grid;grid-template-columns:1fr 1fr; gap:8px}
    .sbSearch{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:10px 12px;
      background:rgba(255,255,255,.06);
      color:var(--text);
      outline:none;
      font-weight:700;
    }

    .chats{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:auto;
      padding-right:2px;
      flex:1 1 auto;
    }
    .chatItem{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.04);
      cursor:pointer;
    }
    .chatItem:hover{background:rgba(255,255,255,.08)}
    .chatItem.active{
      background:rgba(25,195,125,.12);
      border-color:rgba(25,195,125,.35);
    }
    .chatTitle{
      font-size:13px;
      font-weight:850;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:180px;
    }
    .chatMeta{
      color:rgba(197,197,210,.75);
      font-size:11px;
      font-family:var(--mono);
      white-space:nowrap;
    }
    .chatActions{
      display:flex;gap:6px;flex:0 0 auto;
    }
    .iconBtn{
      width:30px;height:30px;border-radius:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .iconBtn:hover{background:rgba(255,255,255,.10)}
    .iconBtn.red{border-color:rgba(255,77,77,.45); background:rgba(255,77,77,.10)}
    .sbFooter{
      border-top:1px solid rgba(255,255,255,.08);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .topbar{
      position:sticky;top:0;z-index:10;
      background:var(--panel2);
      border-bottom:1px solid rgba(255,255,255,.10);
      padding:10px 14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .topbar .title{
      font-weight:950;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:60vw;
    }
    .topbar .sub{
      font-size:12px;color:rgba(197,197,210,.85)
    }
    .topbarRight{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      font-weight:900;
      cursor:pointer;
      font-size:13px
    }
    .btn:hover{background:rgba(255,255,255,.10)}
    .btn.green{border-color:rgba(25,195,125,.55); background:rgba(25,195,125,.12)}

    .chatArea{
      flex:1 1 auto;
      padding:16px 14px 120px;
      max-width:980px;
      width:100%;
      margin:0 auto;
    }
    .row{display:flex;gap:14px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .row:last-child{border-bottom:none}
    .avatar{
      width:34px;height:34px;border-radius:10px;flex:0 0 auto;display:grid;place-items:center;font-weight:900;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.10)
    }
    .avatar.me{background:rgba(122,167,255,.16);border-color:rgba(122,167,255,.35)}
    .avatar.bot{background:rgba(109,70,255,.14);border-color:rgba(109,70,255,.35)}
    .bubble{flex:1;white-space:pre-wrap;word-break:break-word;line-height:1.55;font-size:15px}
    .meta{margin-top:6px;font-size:12px;color:rgba(197,197,210,.85);font-family:var(--mono)}
    .composer{
      position:fixed;left:300px;right:0;bottom:0;
      background:linear-gradient(180deg, rgba(52,53,65,0), rgba(52,53,65,.95) 35%, rgba(52,53,65,1));
      padding:14px;
    }
    .composer .inner{
      max-width:980px;margin:0 auto;background:var(--panel);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;display:flex;gap:10px;
      padding:10px;align-items:flex-end;box-shadow:0 18px 40px rgba(0,0,0,.35)
    }
    textarea{
      flex:1;background:transparent;color:var(--text);border:none;outline:none;
      resize:none;min-height:44px;max-height:160px;font-size:15px;line-height:1.45
    }
    .send{
      background:var(--green);color:#052016;border:none;border-radius:12px;
      padding:10px 14px;font-weight:950;cursor:pointer;min-width:90px
    }
    .send:disabled{opacity:.55;cursor:not-allowed}
    .hintbar{max-width:980px;margin:10px auto 0;display:flex;gap:8px;flex-wrap:wrap;color:var(--muted);font-size:12px}
    .chip{border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);border-radius:999px;padding:7px 10px;cursor:pointer;user-select:none}
    .chip:hover{background:rgba(255,255,255,.10)}

    .typing{display:inline-flex;gap:6px;align-items:center;color:rgba(236,236,241,.9);font-size:14px}
    .dot{width:6px;height:6px;border-radius:999px;background:rgba(236,236,241,.75);animation:bounce 1s infinite}
    .dot:nth-child(2){animation-delay:.12s}
    .dot:nth-child(3){animation-delay:.24s}
    @keyframes bounce{0%,80%,100%{transform:translateY(0);opacity:.6}40%{transform:translateY(-5px);opacity:1}}

    /* Google button inside message */
    .gbtn{
      display:inline-block;
      margin-top:10px;
      padding:9px 12px;
      background:var(--green);
      color:#052016;
      border-radius:12px;
      font-weight:950;
      text-decoration:none;
      border:1px solid rgba(25,195,125,.45);
    }
    .gbtn:hover{filter:brightness(1.05)}
    .note{color:rgba(197,197,210,.85);font-size:12px}

    /* Mobile */
    @media (max-width: 900px){
      .app{grid-template-columns: 1fr}
      .sidebar{display:none}
      .composer{left:0}
      .topbar .title{max-width:55vw}
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sbTop">
        <div class="brand">
          <div class="logoBox"><span>AI</span></div>
          <div class="brandText">
            <b id="sbBrand">Mehmet Emir AI</b>
            <small id="sbSub">Sohbetler</small>
          </div>
        </div>
      </div>

      <button class="sbBtn green" id="newChatBtn">+ Yeni sohbet</button>

      <input class="sbSearch" id="sbSearch" placeholder="Sohbet ara..." />

      <div class="sbTools">
        <button class="sbBtn" id="btnTopics">7. SÄ±nÄ±f</button>
        <button class="sbBtn" id="btnHelp">Komutlar</button>
      </div>

      <div class="chats" id="chatList"></div>

      <div class="sbFooter">
        <button class="sbBtn" id="btnName">Ä°sim Ayarla</button>
        <button class="sbBtn danger" id="wipeAllBtn">Hepsini Sil</button>
        <div class="note">Not: Her ÅŸey cihazÄ±nda (localStorage) saklanÄ±r.</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <header class="topbar">
        <div>
          <div class="title" id="topTitle">Mehmet Emir AI</div>
          <div class="sub" id="topSub">ChatGPT gÃ¶rÃ¼nÃ¼mÃ¼ â€¢ typewriter â€¢ Google buton</div>
        </div>
        <div class="topbarRight">
          <button class="btn" id="renameBtn">Ad deÄŸiÅŸtir</button>
          <button class="btn green" id="clearBtn">Sohbeti temizle</button>
        </div>
      </header>

      <section class="chatArea" id="chatArea"></section>

      <div class="composer">
        <div class="inner">
          <textarea id="inp" placeholder='Bir ÅŸey yaz... (Ã¶rn: "Konu anlat: KarÄ±ÅŸÄ±mlar", "test: karÄ±ÅŸÄ±mlar", "cumhuriyet ne zaman ilan edildi", "telefonum neden yavaÅŸ")'></textarea>
          <button class="send" id="send">GÃ¶nder</button>
        </div>
        <div class="hintbar">
          <span class="chip" data-q="Benim adÄ±m Mehmet">Benim adÄ±mâ€¦</span>
          <span class="chip" data-q="7. sÄ±nÄ±f konular">7. sÄ±nÄ±f konular</span>
          <span class="chip" data-q="Konu anlat: KarÄ±ÅŸÄ±mlar">Konu anlat</span>
          <span class="chip" data-q="test: karÄ±ÅŸÄ±mlar">Test</span>
          <span class="chip" data-q="cumhuriyet ne zaman ilan edildi">Cumhuriyet</span>
          <span class="chip" data-q="3 km kaÃ§ m">Birim</span>
          <span class="chip" data-q="telefonum neden yavaÅŸ">Google</span>
        </div>
      </div>
    </main>
  </div>

<script>
(() => {
  // ---------- utils ----------
  const $ = (id)=>document.getElementById(id);
  const now = () => new Date().toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
  const today = () => new Date().toLocaleDateString("tr-TR",{weekday:"long", year:"numeric", month:"long", day:"numeric"});

  function norm(s){
    return (s||"").toLowerCase()
      .replaceAll("Ä±","i").replaceAll("ÄŸ","g").replaceAll("Ã¼","u")
      .replaceAll("ÅŸ","s").replaceAll("Ã¶","o").replaceAll("Ã§","c")
      .replace(/[?!.,"'â€™]/g," ")
      .replace(/\s+/g," ")
      .trim();
  }

  const store = {
    get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d } },
    set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  };

  // ---------- data model ----------
  // conversations: [{id,title,createdAt,updatedAt,messages:[{who,text,t,html?}]}]
  const state = {
    appTitle: "Mehmet Emir AI",
    userName: store.get("mea_userName",""),
    convs: store.get("mea_convs", []),
    activeId: store.get("mea_activeId", null),
    test: null // per-conversation test state stored inside conv meta? (we keep simple global)
  };

  function saveAll(){
    store.set("mea_userName", state.userName);
    store.set("mea_convs", state.convs);
    store.set("mea_activeId", state.activeId);
  }

  function uid(){
    return "c_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
  }

  function getActive(){
    return state.convs.find(c => c.id === state.activeId) || null;
  }

  function setActive(id){
    state.activeId = id;
    saveAll();
    renderAll();
  }

  function ensureOneConversation(){
    if(state.convs.length === 0){
      const id = uid();
      state.convs.push({
        id,
        title: "Yeni sohbet",
        createdAt: Date.now(),
        updatedAt: Date.now(),
        messages: []
      });
      state.activeId = id;
      saveAll();
    }
    if(!state.activeId || !getActive()){
      state.activeId = state.convs[0].id;
      saveAll();
    }
  }

  // ---------- UI refs ----------
  const chatArea = $("chatArea");
  const chatList = $("chatList");
  const inp = $("inp");
  const sendBtn = $("send");
  const sbSearch = $("sbSearch");

  $("sbBrand").textContent = state.appTitle;
  $("topTitle").textContent = state.appTitle;
  document.title = state.appTitle;

  // ---------- google fallback (HTML) ----------
  function googleAnswerHTML(question){
    const q = encodeURIComponent((question||"").trim());
    const url = `https://www.google.com/search?q=${q}`;
    return {
      text: `Bunu Googleâ€™da arayabilirsin ðŸ‘‡`,
      html: `Bunu Googleâ€™da arayabilirsin ðŸ‘‡\n\n<a class="gbtn" href="${url}" target="_blank" rel="noopener">Googleâ€™da Ara</a>`
    };
  }

  // ---------- typewriter ----------
  function typewriter(el, htmlString, speed=12){
    // we type as plain text, but allow the final HTML to be set at end (so button works)
    const temp = document.createElement("div");
    temp.innerHTML = htmlString;
    const plain = temp.textContent || temp.innerText || "";

    el.textContent = "";
    let i = 0;

    return new Promise(resolve => {
      const tick = () => {
        if(i < plain.length){
          el.textContent += plain.charAt(i);
          i++;
          setTimeout(tick, speed);
        } else {
          // set real HTML at end
          el.innerHTML = htmlString.replace(/\n/g, "<br>");
          resolve();
        }
      };
      tick();
    });
  }

  // ---------- rendering ----------
  function addRowDOM(who, text, tstamp, html){
    const row = document.createElement("div");
    row.className = "row";

    const av = document.createElement("div");
    av.className = "avatar " + (who==="me" ? "me":"bot");
    av.textContent = who==="me" ? "S" : "AI";

    const bub = document.createElement("div");
    bub.className = "bubble";
    if(html){
      bub.innerHTML = html.replace(/\n/g,"<br>");
    } else {
      bub.textContent = text;
    }

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = (who==="me" ? "Sen" : state.appTitle) + " â€¢ " + new Date(tstamp).toLocaleTimeString("tr-TR",{hour:"2-digit",minute:"2-digit"});
    bub.appendChild(meta);

    row.appendChild(av);
    row.appendChild(bub);
    chatArea.appendChild(row);

    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function renderChat(){
    chatArea.innerHTML = "";
    const conv = getActive();
    if(!conv) return;

    if(conv.messages.length === 0){
      addRowDOM("bot",
`Selam! Ben ${state.appTitle} ðŸ˜Ž
â€¢ Sol menÃ¼den sohbetlerini gÃ¶rÃ¼rsÃ¼n
â€¢ YazÄ±yor animasyonu + harf harf yazma var
â€¢ BilmediÄŸim sorularda Google butonu veririm

Denemek iÃ§in:
- "Benim adÄ±m Mehmet"
- "7. sÄ±nÄ±f konular"
- "Konu anlat: KarÄ±ÅŸÄ±mlar"
- "test: karÄ±ÅŸÄ±mlar"
- "cumhuriyet ne zaman ilan edildi"
- "telefonum neden yavaÅŸ"`, Date.now());
      return;
    }

    for(const m of conv.messages){
      addRowDOM(m.who, m.text, m.t, m.html);
    }
  }

  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleDateString("tr-TR",{month:"short", day:"2-digit"});
  }

  function renderSidebar(){
    const q = norm(sbSearch.value || "");
    chatList.innerHTML = "";

    const convsSorted = [...state.convs].sort((a,b)=> (b.updatedAt||0) - (a.updatedAt||0));
    const filtered = q ? convsSorted.filter(c => norm(c.title).includes(q)) : convsSorted;

    for(const c of filtered){
      const item = document.createElement("div");
      item.className = "chatItem" + (c.id === state.activeId ? " active" : "");
      item.onclick = () => setActive(c.id);

      const left = document.createElement("div");
      left.style.minWidth = "0px";

      const title = document.createElement("div");
      title.className = "chatTitle";
      title.textContent = c.title || "Sohbet";

      const meta = document.createElement("div");
      meta.className = "chatMeta";
      meta.textContent = `${fmtDate(c.updatedAt || c.createdAt)} â€¢ ${c.messages?.length || 0} mesaj`;

      left.appendChild(title);
      left.appendChild(meta);

      const actions = document.createElement("div");
      actions.className = "chatActions";

      const ren = document.createElement("button");
      ren.className = "iconBtn";
      ren.title = "Yeniden adlandÄ±r";
      ren.textContent = "âœŽ";
      ren.onclick = (e) => {
        e.stopPropagation();
        const name = prompt("Sohbet adÄ±:", c.title || "Yeni sohbet");
        if(name === null) return;
        c.title = (name || "").trim() || "Yeni sohbet";
        c.updatedAt = Date.now();
        saveAll();
        renderSidebar();
        renderTopbar();
      };

      const del = document.createElement("button");
      del.className = "iconBtn red";
      del.title = "Sil";
      del.textContent = "ðŸ—‘";
      del.onclick = (e) => {
        e.stopPropagation();
        if(!confirm("Bu sohbet silinsin mi?")) return;
        state.convs = state.convs.filter(x => x.id !== c.id);
        if(state.activeId === c.id){
          state.activeId = state.convs[0]?.id || null;
        }
        saveAll();
        ensureOneConversation();
        renderAll();
      };

      actions.appendChild(ren);
      actions.appendChild(del);

      item.appendChild(left);
      item.appendChild(actions);
      chatList.appendChild(item);
    }
  }

  function renderTopbar(){
    const conv = getActive();
    $("topTitle").textContent = conv ? conv.title : state.appTitle;
  }

  function renderAll(){
    renderSidebar();
    renderTopbar();
    renderChat();
  }

  // ---------- content knowledge (same logic as earlier, short but useful) ----------
  const GRADE7 = {
    "Fen Bilimleri": [
      ["GÃ¼neÅŸ Sistemi ve Ã–tesi","Gezegenler, tutulmalar, uzay teknolojileri."],
      ["HÃ¼cre ve BÃ¶lÃ¼nmeler","HÃ¼cre, mitoz-mayoz, bÃ¼yÃ¼me-onarÄ±m."],
      ["Kuvvet ve Enerji","Ä°ÅŸ-gÃ¼Ã§-enerji, sÃ¼rtÃ¼nme, dÃ¶nÃ¼ÅŸÃ¼m."],
      ["Saf Maddeler ve KarÄ±ÅŸÄ±mlar","Element-bileÅŸik, Ã§Ã¶zelti, ayÄ±rma."],
      ["IÅŸÄ±ÄŸÄ±n Madde ile EtkileÅŸimi","YansÄ±ma-kÄ±rÄ±lma, mercekler."],
      ["Elektrik Devreleri","Seri-paralel, parlaklÄ±k, devre elemanlarÄ±."]
    ],
    "Matematik": [
      ["Tam SayÄ±lar","Ä°ÅŸlemler, mutlak deÄŸer."],
      ["Rasyonel SayÄ±lar","Kesir-ondalÄ±k, iÅŸlemler."],
      ["Oran-OrantÄ±","DoÄŸru/ters orantÄ±."],
      ["YÃ¼zdeler","Ä°ndirim-zam hesaplarÄ±."],
      ["Cebirsel Ä°fadeler","SadeleÅŸtirme."],
      ["Denklemler","Basit denklemler."],
      ["Veri Analizi","Tablo-grafik yorumlama."]
    ],
    "TÃ¼rkÃ§e": [
      ["Paragraf","Ana fikir, konu, baÅŸlÄ±k."],
      ["YazÄ±m-Noktalama","Kurallar, iÅŸaretler."],
      ["SÃ¶zcÃ¼k/CÃ¼mlede Anlam","Neden-sonuÃ§, amaÃ§-sonuÃ§ vb."]
    ],
    "Sosyal Bilgiler": [
      ["KÃ¼ltÃ¼r ve Miras","OsmanlÄ± kÃ¼ltÃ¼rÃ¼, miras."],
      ["Etkin VatandaÅŸlÄ±k","Demokrasi, katÄ±lÄ±m."],
      ["Ãœretim-DaÄŸÄ±tÄ±m-TÃ¼ketim","Kaynaklar, ekonomi."]
    ],
    "Din KÃ¼ltÃ¼rÃ¼": [
      ["Ahlak","GÃ¼zel davranÄ±ÅŸlar, sorumluluk."],
      ["Ä°badet ve Dua","Ä°badetin anlamÄ±, dua."]
    ],
    "Ä°ngilizce": [
      ["Daily Routines","Simple Present, saatler."],
      ["Likes/Dislikes","Tercih bildirme."]
    ]
  };

  function listTopics(){
    let out = "7. sÄ±nÄ±f konu haritasÄ± (Ã¶zet):\n";
    for(const [lesson, arr] of Object.entries(GRADE7)){
      out += `\nâ€¢ ${lesson}:\n` + arr.map((x,i)=>`  ${i+1}) ${x[0]}`).join("\n") + "\n";
    }
    out += "\nKullanÄ±m:\n- \"Konu anlat: KarÄ±ÅŸÄ±mlar\"\n- \"test: karÄ±ÅŸÄ±mlar\"";
    return out.trim();
  }

  const REPUBLIC = {
    proclamation: "TÃ¼rkiye Cumhuriyeti 29 Ekim 1923â€™te ilan edildi; Mustafa Kemal AtatÃ¼rk ilk cumhurbaÅŸkanÄ± seÃ§ildi.",
    republicDay: "29 Ekim Cumhuriyet BayramÄ± her yÄ±l 29 Ekimâ€™de kutlanÄ±r."
  };

  const MINI_TESTS = {
    "karisimlar": [
      {q:"Homojen karÄ±ÅŸÄ±m hangisidir?", a:["Kumlu su","Tuzlu su","YaÄŸ-su"], c:1},
      {q:"Tuzlu sudan tuzu ayÄ±rma yÃ¶ntemi?", a:["SÃ¼zme","BuharlaÅŸtÄ±rma","Eleme"], c:1},
      {q:"Kumlu suyu ayÄ±rma yÃ¶ntemi?", a:["SÃ¼zme","MÄ±knatÄ±s","DamÄ±tma"], c:0},
    ],
    "elektrik": [
      {q:"Seri devrede ampul sayÄ±sÄ± artarsa parlaklÄ±k genelde?", a:["Artar","AzalÄ±r","DeÄŸiÅŸmez"], c:1},
      {q:"Paralel devrede bir ampul patlarsa diÄŸerleri?", a:["SÃ¶ner","YanmayÄ± sÃ¼rdÃ¼rÃ¼r","Hepsi patlar"], c:1},
    ]
  };

  // per-conversation test state
  function getTest(conv){ return conv._test || null; }
  function setTest(conv, v){ conv._test = v; }

  function startTest(conv, raw){
    const t = norm(raw);
    if(!t.startsWith("test:")) return null;
    const key = norm(t.split("test:")[1] || "").trim();
    let k=null;
    if(key.includes("karisim")) k="karisimlar";
    else if(key.includes("elektrik")) k="elektrik";
    else return {text:"Bu test yok. Deneyin: test: karÄ±ÅŸÄ±mlar / elektrik"};

    setTest(conv, {key:k, i:0, score:0});
    const q = MINI_TESTS[k][0];
    return {text:`Mini test baÅŸladÄ± (${key}).\nSoru 1: ${q.q}\nA) ${q.a[0]}\nB) ${q.a[1]}\nC) ${q.a[2]}\nCevap: A/B/C`};
  }

  function answerTest(conv, raw){
    const st = getTest(conv);
    if(!st) return null;

    const t = norm(raw);
    if(t === "test iptal" || t === "iptal"){
      setTest(conv, null);
      return {text:"Test modunu kapattÄ±m âœ…"};
    }
    const a = raw.trim().toUpperCase();
    if(!["A","B","C"].includes(a)){
      return {text:`Test modundayÄ±z. Sadece A/B/C yaz.\n(Ã‡Ä±kmak iÃ§in: "test iptal")`};
    }

    const bank = MINI_TESTS[st.key];
    const q = bank[st.i];
    const idx = {A:0,B:1,C:2}[a];

    let out = "";
    if(idx===q.c){ st.score++; out += "âœ… DoÄŸru!\n"; }
    else out += `âŒ YanlÄ±ÅŸ. DoÄŸru cevap: ${["A","B","C"][q.c]}\n`;

    st.i++;
    if(st.i >= bank.length){
      out += `\nTest bitti! Skor: ${st.score}/${bank.length}\nYeni test: "test: karÄ±ÅŸÄ±mlar" veya "test: elektrik"`;
      setTest(conv, null);
      return {text:out.trim()};
    }
    const nq = bank[st.i];
    out += `Soru ${st.i+1}: ${nq.q}\nA) ${nq.a[0]}\nB) ${nq.a[1]}\nC) ${nq.a[2]}\nCevap: A/B/C`;
    return {text:out.trim()};
  }

  function tryMath(raw){
    let s = raw.toLowerCase()
      .replaceAll("Ã§arpÄ±","*").replaceAll("carpi","*").replaceAll("Ã—","*").replaceAll("x","*")
      .replaceAll("artÄ±","+").replaceAll("arti","+")
      .replaceAll("eksi","-")
      .replaceAll("bÃ¶lÃ¼","/").replaceAll("bolu","/").replaceAll("Ã·","/")
      .replaceAll(",",".");
    s = s.replace(/[^0-9+\-*/().\s]/g,"").trim();
    if(!s) return null;
    if(!(/\d/.test(s) && /[+\-*/]/.test(s))) return null;
    try{
      const v = Function('"use strict";return ('+s+')')();
      if(!isFinite(v)) return {text:"SonuÃ§ tanÄ±msÄ±z (0â€™a bÃ¶lme olabilir)."};
      const pretty = (Math.abs(v)%1===0) ? String(v) : String(Number(v.toFixed(6)));
      return {text:`SonuÃ§: ${pretty}\nÄ°ÅŸlem: ${s}`};
    }catch{ return null; }
  }

  function unitConvert(t){
    const m1 = t.match(/(\d+(?:\.\d+)?)\s*km\s*(kac|kaÃ§)?\s*m/);
    if(m1) return {text:`${m1[1]} km = ${Number(m1[1])*1000} m`};
    const m2 = t.match(/(\d+(?:\.\d+)?)\s*m\s*(kac|kaÃ§)?\s*cm/);
    if(m2) return {text:`${m2[1]} m = ${Number(m2[1])*100} cm`};
    const m3 = t.match(/(\d+(?:\.\d+)?)\s*kg\s*(kac|kaÃ§)?\s*g/);
    if(m3) return {text:`${m3[1]} kg = ${Number(m3[1])*1000} g`};
    const m4 = t.match(/(\d+(?:\.\d+)?)\s*l\s*(kac|kaÃ§)?\s*ml/);
    if(m4) return {text:`${m4[1]} L = ${Number(m4[1])*1000} mL`};
    return null;
  }

  function explainTopic(conv, raw){
    const t = norm(raw);

    if(t.includes("7 sinif") && t.includes("konu")) return {text:listTopics()};

    if(t.startsWith("konu anlat:")){
      const topic = norm(raw.split(":")[1] || "").trim();
      conv._lastTopic = topic;

      if(topic.includes("elektrik")){
        return {text:`Elektrik Devreleri (Ã¶zet):
â€¢ Devre elemanlarÄ±: pil, ampul, anahtar, kablo.
â€¢ KapalÄ± devre: yanar. AÃ§Ä±k devre: yanmaz.
â€¢ Seri devre: tek yol; biri Ã§Ä±karsa devre bozulur.
â€¢ Paralel devre: kollar baÄŸÄ±msÄ±z Ã§alÄ±ÅŸÄ±r.
Ä°stersen: "test: elektrik"`};
      }
      if(topic.includes("karisim")){
        return {text:`Saf Maddeler ve KarÄ±ÅŸÄ±mlar (Ã¶zet):
â€¢ Saf madde: element/bileÅŸik.
â€¢ KarÄ±ÅŸÄ±m: homojen (tuzlu su) / heterojen (kumlu su).
â€¢ AyÄ±rma: sÃ¼zme, eleme, mÄ±knatÄ±s, buharlaÅŸtÄ±rma.
Ä°stersen: "test: karÄ±ÅŸÄ±mlar"`};
      }
      if(topic.includes("mitoz") || topic.includes("mayoz") || topic.includes("bolunme") || topic.includes("bÃ¶lÃ¼nme")){
        return {text:`HÃ¼cre BÃ¶lÃ¼nmeleri:
â€¢ Mitoz: 1â†’2 aynÄ± hÃ¼cre, bÃ¼yÃ¼me-onarÄ±m, kromozom sayÄ±sÄ± deÄŸiÅŸmez.
â€¢ Mayoz: 1â†’4 farklÄ± hÃ¼cre, Ã¼reme, kromozom sayÄ±sÄ± yarÄ±ya iner.`};
      }
      return null;
    }
    return null;
  }

  function dailyFAQ(t){
    if(t.includes("saat kac") || t.includes("saat kaÃ§")) return {text:`Åžu an saat: ${new Date().toLocaleTimeString("tr-TR")}`};
    if(t.includes("bugun") && (t.includes("gun") || t.includes("tarih"))) return {text:`BugÃ¼n: ${today()}`};
    if(t.includes("nasilsin") || t.includes("nasi gidiyor")) return {text:"Ä°yiyim ðŸ™‚ Sen nasÄ±lsÄ±n?"};
    return null;
  }

  function setNameFromText(raw){
    const m = raw.match(/benim ad[Ä±i]m\s+(.+)/i);
    if(!m || !m[1]) return null;
    state.userName = m[1].trim().replace(/[.!?]/g,"");
    saveAll();
    return {text:`Tamam ${state.userName} ðŸ˜Ž Ä°smini kaydettim.`};
  }

  function helpText(){
    return {text:`Komutlar:
â€¢ "Benim adÄ±m ..." â†’ isim kaydeder
â€¢ "7. sÄ±nÄ±f konular" â†’ konu haritasÄ±
â€¢ "Konu anlat: ..." â†’ konu anlatÄ±r
â€¢ "test: karÄ±ÅŸÄ±mlar" / "test: elektrik" â†’ mini test
â€¢ "cumhuriyet ne zaman ilan edildi" â†’ Cumhuriyet
â€¢ Hesap: "12 bÃ¶lÃ¼ 3" / "7*8"
â€¢ Birim: "3 km kaÃ§ m" / "2 kg kaÃ§ g"
â€¢ BilmediÄŸim sorularda: Google butonu veririm.`};
  }

  function smartAnswer(conv, raw){
    const t = norm(raw);

    // name
    const nameAns = setNameFromText(raw);
    if(nameAns) return nameAns;

    // test
    const testAns = answerTest(conv, raw);
    if(testAns) return testAns;
    const testStart = startTest(conv, raw);
    if(testStart) return testStart;

    // republic
    if(t.includes("cumhuriyet")){
      if(t.includes("ne zaman") || t.includes("ilan")){
        return {text: `${REPUBLIC.proclamation}\n${REPUBLIC.republicDay}`};
      }
      return {text: REPUBLIC.republicDay};
    }

    // topics
    const topic = explainTopic(conv, raw);
    if(topic) return topic;

    // units
    const convRes = unitConvert(t);
    if(convRes) return convRes;

    // math
    const math = tryMath(raw);
    if(math) return math;

    // daily
    const faq = dailyFAQ(t);
    if(faq) return faq;

    // fallback => google html button
    return googleAnswerHTML(raw);
  }

  // ---------- typing row ----------
  function addTypingRow(){
    const row = document.createElement("div");
    row.className = "row";
    row.id = "typingRow";

    const av = document.createElement("div");
    av.className = "avatar bot";
    av.textContent = "AI";

    const bub = document.createElement("div");
    bub.className = "bubble";
    bub.innerHTML = `<span class="typing">${state.appTitle} yazÄ±yor <span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.textContent = `${state.appTitle} â€¢ ${now()}`;
    bub.appendChild(meta);

    row.appendChild(av);
    row.appendChild(bub);
    chatArea.appendChild(row);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function removeTypingRow(){
    const t = document.getElementById("typingRow");
    if(t) t.remove();
  }

  function autoResize(){
    inp.style.height = "0px";
    inp.style.height = Math.min(inp.scrollHeight, 160) + "px";
  }

  // ---------- sending ----------
  async function send(){
    const text = inp.value.trim();
    if(!text) return;

    const conv = getActive();
    if(!conv) return;

    inp.value = "";
    autoResize();
    sendBtn.disabled = true;

    // add user message
    conv.messages.push({who:"me", text, t: Date.now()});
    conv.updatedAt = Date.now();
    if(conv.title === "Yeni sohbet"){
      conv.title = text.slice(0, 28) + (text.length>28 ? "â€¦" : "");
    }
    saveAll();
    renderAll();

    // typing row
    addTypingRow();

    // compute answer
    const ans = smartAnswer(conv, text);

    // remove typing row and typewriter the bot msg
    setTimeout(async () => {
      removeTypingRow();

      // create bot row dom first (empty bubble)
      const row = document.createElement("div");
      row.className = "row";

      const av = document.createElement("div");
      av.className = "avatar bot";
      av.textContent = "AI";

      const bub = document.createElement("div");
      bub.className = "bubble";
      bub.textContent = "";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${state.appTitle} â€¢ ${now()}`;
      bub.appendChild(meta);

      row.appendChild(av);
      row.appendChild(bub);
      chatArea.appendChild(row);
      chatArea.scrollTop = chatArea.scrollHeight;

      // typewriter content (keep meta at end after typing)
      meta.remove();

      const html = ans.html ? ans.html : (ans.text || "");
      await typewriter(bub, (ans.html ? html : (html || "").replace(/\n/g,"<br>")), 12);

      bub.appendChild(meta);

      // persist bot message
      conv.messages.push({who:"bot", text: (ans.text || ""), html: (ans.html || null), t: Date.now()});
      conv.updatedAt = Date.now();
      saveAll();
      renderSidebar(); // update counts/title
      sendBtn.disabled = false;
      inp.focus();
    }, 350);
  }

  // ---------- actions ----------
  function newChat(){
    const id = uid();
    state.convs.unshift({
      id,
      title:"Yeni sohbet",
      createdAt: Date.now(),
      updatedAt: Date.now(),
      messages:[]
    });
    state.activeId = id;
    saveAll();
    renderAll();
  }

  function clearActiveChat(){
    const conv = getActive();
    if(!conv) return;
    if(!confirm("Bu sohbetin iÃ§i temizlensin mi?")) return;
    conv.messages = [];
    conv.updatedAt = Date.now();
    saveAll();
    renderAll();
  }

  function renameActiveChat(){
    const conv = getActive();
    if(!conv) return;
    const name = prompt("Sohbet adÄ±:", conv.title || "Yeni sohbet");
    if(name === null) return;
    conv.title = (name || "").trim() || "Yeni sohbet";
    conv.updatedAt = Date.now();
    saveAll();
    renderAll();
  }

  function wipeAll(){
    if(!confirm("TÃœM sohbetler silinsin mi?")) return;
    state.convs = [];
    state.activeId = null;
    saveAll();
    ensureOneConversation();
    renderAll();
  }

  function setUserName(){
    const n = prompt("AdÄ±n ne? (Ã–rn: Mehmet)", state.userName || "");
    if(n === null) return;
    state.userName = (n||"").trim();
    saveAll();
    alert(state.userName ? `Tamam ${state.userName} ðŸ™‚` : "Ä°sim temizlendi.");
  }

  // ---------- hook up ----------
  $("newChatBtn").onclick = newChat;
  $("clearBtn").onclick = clearActiveChat;
  $("renameBtn").onclick = renameActiveChat;
  $("wipeAllBtn").onclick = wipeAll;
  $("btnName").onclick = setUserName;

  $("btnHelp").onclick = () => {
    const conv = getActive();
    if(!conv) return;
    conv.messages.push({who:"bot", text: helpText().text, t: Date.now()});
    conv.updatedAt = Date.now();
    saveAll();
    renderAll();
  };

  $("btnTopics").onclick = () => {
    const conv = getActive();
    if(!conv) return;
    conv.messages.push({who:"bot", text: listTopics(), t: Date.now()});
    conv.updatedAt = Date.now();
    saveAll();
    renderAll();
  };

  sbSearch.addEventListener("input", renderSidebar);

  document.querySelectorAll("[data-q]").forEach(ch => {
    ch.addEventListener("click", () => {
      inp.value = ch.getAttribute("data-q");
      autoResize();
      inp.focus();
    });
  });

  $("send").onclick = send;
  inp.addEventListener("input", autoResize);
  inp.addEventListener("keydown", (e)=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  // ---------- init ----------
  ensureOneConversation();
  renderAll();
  autoResize();

})();
</script>
</body>
</html>
