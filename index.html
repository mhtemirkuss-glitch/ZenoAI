<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EMÄ°R BABA â€¢ Sohbet + Bilgi</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#151a2e; --panel2:#101428;
      --text:#e9ecff; --muted:#a8b0d6; --me:#2e6bff; --bot:#6d46ff;
      --border:rgba(255,255,255,.09);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#0b0e19,#0f1220);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto; padding:18px;}
    .topbar{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 14px; border:1px solid var(--border); border-radius:22px;
      background:rgba(21,26,46,.75); backdrop-filter: blur(8px);
    }
    .brand{display:flex; gap:12px; align-items:center;}
    .logo{
      width:44px;height:44px;border-radius:14px;background:linear-gradient(135deg,#33d3ff,#6d46ff);
      display:grid;place-items:center;font-weight:800;
      color:#071023; box-shadow:0 8px 24px rgba(0,0,0,.35);
    }
    .title{line-height:1.1}
    .title b{display:block;font-size:16px}
    .title small{color:var(--muted)}
    .tools{display:flex; gap:8px; flex-wrap:wrap; align-items:center;}
    .chip{
      border:1px solid var(--border); background:rgba(16,20,40,.6);
      color:var(--text); padding:8px 10px; border-radius:999px;
      font-size:13px; cursor:pointer;
    }
    .chip:hover{border-color:rgba(255,255,255,.18)}
    .chip.primary{background:rgba(46,107,255,.18); border-color:rgba(46,107,255,.45)}
    .chip.danger{background:rgba(255,70,70,.12); border-color:rgba(255,70,70,.35)}
    .row{display:grid; grid-template-columns: 1fr 320px; gap:14px; margin-top:14px;}
    @media (max-width:900px){ .row{grid-template-columns:1fr} }
    .card{
      border:1px solid var(--border); border-radius:22px;
      background:rgba(21,26,46,.55); backdrop-filter: blur(8px);
      overflow:hidden;
    }
    .chat{
      display:flex; flex-direction:column; height:72vh; min-height:520px;
    }
    .messages{padding:14px; overflow:auto; flex:1; background:rgba(16,20,40,.35)}
    .msg{max-width:78%; padding:12px 12px; border-radius:18px; margin:10px 0; border:1px solid var(--border)}
    .msg.bot{background:linear-gradient(180deg,rgba(109,70,255,.20),rgba(109,70,255,.12));}
    .msg.me{background:linear-gradient(180deg,rgba(46,107,255,.22),rgba(46,107,255,.12)); margin-left:auto}
    .meta{display:flex; gap:8px; align-items:center; justify-content:space-between; font-size:12px; color:var(--muted); margin-top:6px}
    .inputbar{
      padding:12px; display:flex; gap:10px; border-top:1px solid var(--border);
      background:rgba(21,26,46,.75);
    }
    textarea{
      flex:1; resize:none; height:54px; padding:12px 12px; border-radius:16px;
      border:1px solid var(--border); background:rgba(16,20,40,.6); color:var(--text);
      outline:none; font-size:15px;
    }
    button{
      border:none; border-radius:16px; padding:0 16px; font-weight:700; cursor:pointer;
      background:linear-gradient(135deg,#2e6bff,#6d46ff); color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.25);
    }
    button:active{transform:translateY(1px)}
    .side{padding:14px}
    .side h3{margin:6px 0 10px 0}
    .side p,.side li{color:var(--muted); font-size:13px; line-height:1.35}
    .quick{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .quick button{
      background:rgba(255,255,255,.07); border:1px solid var(--border); color:var(--text);
      box-shadow:none; padding:10px 10px; border-radius:14px; font-weight:600; font-size:13px;
    }
    .quick button:hover{border-color:rgba(255,255,255,.18)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size:12px; color:#cfe1ff}
    .sep{height:1px; background:var(--border); margin:12px 0}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">EB</div>
        <div class="title">
          <b>EMÄ°R BABA â€¢ Sohbet + Bilgi</b>
          <small>Tek dosya â€¢ Offline â€¢ Ä°sim hatÄ±rlar â€¢ 7. sÄ±nÄ±f â€¢ Fen/Tarih/Mat + daha fazlasÄ±</small>
        </div>
      </div>
      <div class="tools">
        <span class="badge" id="nameBadge">Ä°sim: â€”</span>
        <span class="chip primary" id="helpBtn">YardÄ±m</span>
        <span class="chip" id="topicsBtn">7. SÄ±nÄ±f Konular</span>
        <span class="chip" id="resetBtn">SÄ±fÄ±rla</span>
      </div>
    </div>

    <div class="row">
      <div class="card chat">
        <div class="messages" id="messages"></div>
        <div class="inputbar">
          <textarea id="input" placeholder='Bir ÅŸey yaz... (Ã¶rn: "Sana bir ÅŸey sormak istiyorum" / "12 bÃ¶lÃ¼ 3" / "osmanlÄ±nÄ±n 2. padiÅŸahÄ±" / "Konu anlat: Elektrik devreleri")'></textarea>
          <button id="send">GÃ¶nder</button>
        </div>
      </div>

      <div class="card side">
        <h3>HÄ±zlÄ± Denemeler</h3>
        <p>Bir butona tÄ±kla, kutuya otomatik yazar.</p>
        <div class="quick" id="quick"></div>
        <div class="sep"></div>
        <p class="kbd">
          Komutlar:<br/>
          â€¢ <b>Benim adÄ±m ...</b><br/>
          â€¢ <b>Sana bir ÅŸey sormak istiyorum</b><br/>
          â€¢ <b>Konu anlat: ...</b> / <b>... detay</b><br/>
          â€¢ <b>7. sÄ±nÄ±f konular</b><br/>
          â€¢ <b>test: ...</b> (mini test modu)
        </p>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id)=>document.getElementById(id);
  const messagesEl = $("messages");
  const inputEl = $("input");
  const nameBadge = $("nameBadge");

  const store = {
    get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback } },
    set(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
  };

  const state = {
    name: store.get("eb_name", ""),
    chat: store.get("eb_chat", []),
    greeted: store.get("eb_greeted", false),
    lastTopic: store.get("eb_lastTopic", ""), // konu anlat iÃ§in
    testMode: store.get("eb_testMode", null), // {subject, topic, qIndex, score}
  };

  function nowTime(){
    const d = new Date();
    return d.toLocaleTimeString("tr-TR", {hour:"2-digit", minute:"2-digit"});
  }

  function setName(n){
    state.name = n.trim();
    store.set("eb_name", state.name);
    nameBadge.textContent = "Ä°sim: " + (state.name || "â€”");
  }

  function pushMsg(who, text){
    const msg = { who, text, t: nowTime() };
    state.chat.push(msg);
    store.set("eb_chat", state.chat);
    renderMsg(msg);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function renderMsg(m){
    const div = document.createElement("div");
    div.className = "msg " + (m.who === "me" ? "me":"bot");
    div.innerHTML = `
      <div>${escapeHtml(m.text).replace(/\n/g,"<br/>")}</div>
      <div class="meta">
        <span>${m.who === "me" ? "Sen" : "EMÄ°R BABA"}</span>
        <span>${m.t}</span>
      </div>
    `;
    messagesEl.appendChild(div);
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function clearUI(){
    messagesEl.innerHTML = "";
    state.chat.forEach(renderMsg);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  // --- Bilgi BankasÄ± (Offline) ---

  const OTTOMAN_SULTANS = [
    "Osman Gazi",
    "Orhan Gazi",
    "I. Murad (HÃ¼davendigÃ¢r)",
    "YÄ±ldÄ±rÄ±m Bayezid",
    "I. Mehmed (Ã‡elebi)",
    "II. Murad",
    "II. Mehmed (Fatih Sultan Mehmed)",
    "II. Bayezid",
    "I. Selim (Yavuz)",
    "I. SÃ¼leyman (Kanuni)",
    "II. Selim",
    "III. Murad",
    "III. Mehmed",
    "I. Ahmed",
    "I. Mustafa",
    "II. Osman (GenÃ§ Osman)",
    "IV. Murad",
    "I. Ä°brahim",
    "IV. Mehmed",
    "II. SÃ¼leyman",
    "II. Ahmed",
    "II. Mustafa",
    "III. Ahmed",
    "I. Mahmud",
    "III. Osman",
    "III. Mustafa",
    "I. AbdÃ¼lhamid",
    "III. Selim",
    "IV. Mustafa",
    "II. Mahmud",
    "AbdÃ¼lmecid",
    "AbdÃ¼laziz",
    "V. Murad",
    "II. AbdÃ¼lhamid",
    "V. Mehmed (ReÅŸad)",
    "VI. Mehmed (Vahdeddin)"
  ];

  const SCIENCE_FORMULAS = [
    {k:"HÄ±z", v:"v = yol / zaman"},
    {k:"YoÄŸunluk", v:"d = kÃ¼tle / hacim"},
    {k:"Ä°ÅŸ", v:"W = Kuvvet Ã— Yol (aynÄ± doÄŸrultu)"},
    {k:"GÃ¼Ã§", v:"P = Ä°ÅŸ / Zaman"},
    {k:"BasÄ±nÃ§", v:"P = Kuvvet / YÃ¼zey AlanÄ±"},
    {k:"AÄŸÄ±rlÄ±k", v:"G = m Ã— g  (g â‰ˆ 9,8 N/kg)"},
  ];

  // 7. sÄ±nÄ±f ana konu haritasÄ± (genel Ã§erÃ§eve)
  const GRADE7_TOPICS = {
    "Fen Bilimleri": [
      "GÃ¼neÅŸ Sistemi ve Ã–tesi",
      "HÃ¼cre ve BÃ¶lÃ¼nmeler (Mitoz/Mayoz)",
      "Kuvvet ve Enerji",
      "Saf Maddeler ve KarÄ±ÅŸÄ±mlar",
      "IÅŸÄ±ÄŸÄ±n Madde ile EtkileÅŸimi",
      "Elektrik Devreleri"
    ],
    "Matematik": [
      "Tam SayÄ±lar / Rasyonel SayÄ±lar",
      "Oran-OrantÄ± / YÃ¼zdeler",
      "Cebirsel Ä°fadeler / Denklem",
      "DoÄŸrular-AÃ§Ä±lar / Ã‡okgenler",
      "Ã‡ember ve Daire (temel)",
      "Veri Analizi (grafikler)"
    ],
    "TÃ¼rkÃ§e": [
      "Paragraf (ana fikir-yardÄ±mcÄ± fikir)",
      "SÃ¶zcÃ¼kte/SÃ¶zde Anlam, Deyim-AtasÃ¶zÃ¼",
      "CÃ¼mlede Anlam",
      "YazÄ±m KurallarÄ± / Noktalama",
      "Fiilimsiler / Fiilde YapÄ± (temel)",
      "Metin TÃ¼rleri (hikÃ¢ye, ÅŸiir, bilgilendirici)"
    ],
    "Sosyal Bilgiler": [
      "Ä°letiÅŸim ve Ä°nsan Ä°liÅŸkileri",
      "NÃ¼fus ve YerleÅŸme",
      "Ãœretim-DaÄŸÄ±tÄ±m-TÃ¼ketim",
      "Bilim-Teknoloji-Toplum",
      "Demokrasi ve VatandaÅŸlÄ±k"
    ],
    "Din KÃ¼ltÃ¼rÃ¼": [
      "Ä°badet ve Dua",
      "Ahlak (gÃ¼zel davranÄ±ÅŸlar)",
      "Peygamberlerin Ã¶rnekliÄŸi (genel)",
      "Ä°slam'da bilgi ve sorumluluk (genel)"
    ],
    "Ä°ngilizce": [
      "Daily Routines / Simple Present",
      "Likes-Dislikes",
      "Descriptions (People/Places)",
      "Past Simple (temel)",
      "Shopping / Numbers / Prices"
    ]
  };

  const TOPIC_EXPLAINS = {
    "elektrik devreleri": `Elektrik Devreleri (7. sÄ±nÄ±f - kÄ±sa):
â€¢ Devre elemanlarÄ±: pil, ampul, anahtar, baÄŸlantÄ± kablosu.
â€¢ KapalÄ± devre olursa ampul yanar; aÃ§Ä±k devrede yanmaz.
â€¢ Seri devrede: ampuller paylaÅŸÄ±r, biri Ã§Ä±karsa devre bozulur.
â€¢ Paralel devrede: kollar baÄŸÄ±msÄ±z; bir ampul bozulsa diÄŸerleri yanabilir.
Detay istersen: "Elektrik devreleri detay" yaz.`,
    "karÄ±ÅŸÄ±mlar": `KarÄ±ÅŸÄ±mlar (7. sÄ±nÄ±f - kÄ±sa):
â€¢ Homojen (Ã§Ã¶zelti): her yeri aynÄ± (tuzlu su).
â€¢ Heterojen: her yeri aynÄ± deÄŸil (kumlu su).
â€¢ AyÄ±rma yÃ¶ntemleri: sÃ¼zme, eleme, mÄ±knatÄ±s, buharlaÅŸtÄ±rma, yoÄŸunluk farkÄ±.
Detay istersen: "KarÄ±ÅŸÄ±mlar detay" yaz.`,
    "ibadet ve dua": `Din KÃ¼ltÃ¼rÃ¼ â€¢ Ä°badet ve Dua (kÄ±sa):
â€¢ Ä°badet: Allahâ€™a kulluk amacÄ±yla yapÄ±lan davranÄ±ÅŸlar (namaz, oruÃ§, zekÃ¢t gibi).
â€¢ Dua: Allahâ€™tan isteme, ÅŸÃ¼kÃ¼r ve baÄŸÄ±ÅŸlanma dileme.
Detay istersen: "Ä°badet ve Dua detay" yaz.`
  };

  // Mini test bankasÄ± (Ã§ok basit Ã¶rnek)
  const MINI_TESTS = {
    "fen: karÄ±ÅŸÄ±mlar": [
      {q:"Homojen karÄ±ÅŸÄ±ma Ã¶rnek hangisidir?", a:["Kumlu su","Tuzlu su","YaÄŸ-su"], c:1},
      {q:"SÃ¼zme yÃ¶ntemi hangi karÄ±ÅŸÄ±mlarda iÅŸe yarar?", a:["KatÄ±+sÄ±vÄ±","Gaz+gaz","SÄ±vÄ±+sÄ±vÄ±"], c:0},
    ],
    "mat: bÃ¶lme": [
      {q:"12 Ã· 3 kaÃ§tÄ±r?", a:["3","4","5"], c:1},
      {q:"20 Ã· 5 kaÃ§tÄ±r?", a:["2","4","5"], c:1},
    ],
    "tarih: osmanlÄ±": [
      {q:"Ä°stanbulâ€™u fetheden padiÅŸah kimdir?", a:["Yavuz","Fatih","Kanuni"], c:1},
      {q:"OsmanlÄ±â€™nÄ±n kurucusu kimdir?", a:["Osman Gazi","Orhan Gazi","I. Murad"], c:0},
    ]
  };

  // --- YardÄ±mcÄ±lar ---
  function normalize(s){
    return s.toLowerCase()
      .replaceAll("Ä±","i").replaceAll("Ä°","i")
      .replaceAll("ÅŸ","s").replaceAll("ÄŸ","g")
      .replaceAll("Ã¼","u").replaceAll("Ã¶","o")
      .replaceAll("Ã§","c")
      .trim();
  }

  function looksLikeMath(expr){
    // 12 bÃ¶lÃ¼ 3 / 12/3 / 12 Ã· 3 / 12x3 / 12*3 gibi
    const s = normalize(expr)
      .replaceAll("bolu","/").replaceAll("bÃ¶lÃ¼","/")
      .replaceAll("Ã·","/").replaceAll("Ã—","*").replaceAll("x","*");
    return /^[0-9\s+\-*/().]+$/.test(s) && /[0-9]/.test(s) && /[+\-*/]/.test(s);
  }

  function safeEvalMath(expr){
    const s = normalize(expr)
      .replaceAll("bolu","/").replaceAll("bÃ¶lÃ¼","/")
      .replaceAll("Ã·","/").replaceAll("Ã—","*").replaceAll("x","*")
      .replaceAll(",",".");

    // GÃ¼venlik: sadece rakam ve iÅŸlem karakterleri
    if(!/^[0-9\s+\-*/().]+$/.test(s)) return null;

    try{
      // eslint-disable-next-line no-new-func
      const val = Function('"use strict";return (' + s + ')')();
      if(typeof val === "number" && isFinite(val)) return val;
      return null;
    }catch{
      return null;
    }
  }

  function getOrdinalNumberQuestion(textN){
    // "osmanlÄ±nÄ±n 2. padiÅŸahÄ±" gibi
    const m = textN.match(/osmanli.*?(\d{1,2})\s*\.?\s*padi(s|ÅŸ)ah/);
    if(!m) return null;
    const n = parseInt(m[1],10);
    if(!Number.isFinite(n) || n<1 || n>OTTOMAN_SULTANS.length) return null;
    return n;
  }

  function replyWelcome(){
    const n = state.name ? ` ${state.name}` : "";
    return `Selam${n}! Ben EMÄ°R BABA ğŸ˜\nÄ°stersen "Benim adÄ±m ..." yaz, adÄ±nÄ± hatÄ±rlayayÄ±m.\nSorunu direkt yaz: fen / matematik / tarih / tÃ¼rkÃ§e / din / ingilizceâ€¦ elimden geldiÄŸince cevaplarÄ±m.`;
  }

  function replyHelp(){
    return `KÄ±sayollar:
â€¢ "Benim adÄ±m Mehmet" â†’ adÄ±nÄ± kaydeder.
â€¢ "Sana bir ÅŸey sormak istiyorum" â†’ ben: "Tabiki EMÄ°R BABA, ne istersen yaz ğŸ˜"
â€¢ "7. sÄ±nÄ±f konular" â†’ ders ders konu listesi
â€¢ "Konu anlat: elektrik devreleri" â†’ konu anlatÄ±r
â€¢ "12 bÃ¶lÃ¼ 3" / "25*4" â†’ hesaplar
â€¢ "osmanlÄ±nÄ±n 4. padiÅŸahÄ± kim" â†’ direkt sÃ¶yler
â€¢ "test: karÄ±ÅŸÄ±mlar" / "test: osmanlÄ±" â†’ mini test baÅŸlatÄ±r`;
  }

  function listTopics(){
    let out = "7. sÄ±nÄ±f konular (genel Ã§erÃ§eve):\n";
    for(const [lesson, arr] of Object.entries(GRADE7_TOPICS)){
      out += `\nâ€¢ ${lesson}:\n  - ` + arr.join("\n  - ");
    }
    out += `\n\nÄ°stersen: "Konu anlat: karÄ±ÅŸÄ±mlar" gibi yaz.`;
    return out;
  }

  function answerScienceFormulas(textN){
    if(!textN.includes("formul") && !textN.includes("formÃ¼l") && !textN.includes("formuller") && !textN.includes("formÃ¼ller")) return null;
    let out = "BazÄ± temel formÃ¼ller:\n";
    for(const f of SCIENCE_FORMULAS){
      out += `â€¢ ${f.k}: ${f.v}\n`;
    }
    out += "\nÄ°stersen hangi konunun formÃ¼lÃ¼nÃ¼ istiyorsun, sÃ¶yle (Ã¶rn: basÄ±nÃ§ / hÄ±z / yoÄŸunluk).";
    return out.trim();
  }

  function answerOttoman(textN){
    if(textN.includes("osmanli") && (textN.includes("padisah") || textN.includes("padiÅŸah"))){
      const ord = getOrdinalNumberQuestion(textN);
      if(ord){
        return `OsmanlÄ±'nÄ±n ${ord}. padiÅŸahÄ±: **${OTTOMAN_SULTANS[ord-1]}**.`;
      }
      if(textN.includes("tum") || textN.includes("hepsi") || textN.includes("liste")){
        return "OsmanlÄ± padiÅŸahlarÄ± (sÄ±rasÄ±yla):\nâ€¢ " + OTTOMAN_SULTANS.join("\nâ€¢ ");
      }
    }
    if(textN.includes("istanbulu") || textN.includes("istanbulu kim") || textN.includes("istanbulu hangi")){
      if(textN.includes("fethet")){
        return "Ä°stanbulâ€™u fetheden padiÅŸah: **II. Mehmed (Fatih Sultan Mehmed)** (1453).";
      }
    }
    return null;
  }

  function answerTopicExplain(textRaw){
    // "Konu anlat: X" veya "... detay"
    const tN = normalize(textRaw);

    if(tN.startsWith("konu anlat:")){
      const topic = tN.split("konu anlat:")[1].trim();
      state.lastTopic = topic;
      store.set("eb_lastTopic", state.lastTopic);

      // yakala
      if(TOPIC_EXPLAINS[topic]) return TOPIC_EXPLAINS[topic];

      // benzer anahtarlar
      if(topic.includes("elektrik")) return TOPIC_EXPLAINS["elektrik devreleri"];
      if(topic.includes("karisim")) return TOPIC_EXPLAINS["karÄ±ÅŸÄ±mlar"];
      if(topic.includes("ibadet") || topic.includes("dua")) return TOPIC_EXPLAINS["ibadet ve dua"];

      return `Konu anlatabilmem iÃ§in konuyu biraz daha net yaz: Ã¶rn.\nâ€¢ "Konu anlat: KarÄ±ÅŸÄ±mlar"\nâ€¢ "Konu anlat: Elektrik devreleri"\nâ€¢ "Konu anlat: Mitoz ve mayoz"`;
    }

    if(tN.endsWith("detay") || tN.includes(" detay")){
      const base = (tN.replace("detay","").trim()) || state.lastTopic;
      if(!base) return null;

      if(base.includes("elektrik")){
        return `Elektrik Devreleri (detay):
â€¢ Devre: Elektrik akÄ±mÄ±nÄ±n dolaÅŸtÄ±ÄŸÄ± yol.
â€¢ Seri devre: Tek yol vardÄ±r. Ampuller eklenirse parlaklÄ±k azalabilir. Biri Ã§Ä±karsa hepsi sÃ¶ner.
â€¢ Paralel devre: Birden fazla yol vardÄ±r. Ampuller baÄŸÄ±msÄ±z Ã§alÄ±ÅŸabilir.
â€¢ Anahtar: Devreyi aÃ§Ä±p kapatÄ±r.
â€¢ Pil: Enerji kaynaÄŸÄ±dÄ±r.
Ä°stersen sana 2â€“3 soru da sorup birlikte pekiÅŸtirelim.`;
      }
      if(base.includes("karisim")){
        return `KarÄ±ÅŸÄ±mlar (detay):
â€¢ Homojen (Ã§Ã¶zelti): Ã‡Ã¶zÃ¼nen + Ã§Ã¶zÃ¼cÃ¼. Ã–rn: tuzlu su.
â€¢ Heterojen: KarÄ±ÅŸÄ±mÄ±n her yerinde aynÄ± gÃ¶rÃ¼nÃ¼m yok. Ã–rn: kumlu su.
AyÄ±rma yÃ¶ntemleri:
â€¢ SÃ¼zme: katÄ±+sÄ±vÄ± (kumlu su)
â€¢ Eleme: katÄ±+katÄ± (pirinÃ§+nohut)
â€¢ MÄ±knatÄ±s: mÄ±knatÄ±slanan maddeler (demir tozu)
â€¢ BuharlaÅŸtÄ±rma: Ã§Ã¶zeltiler (tuzlu su â†’ tuz)
Ä°stersen â€œhomojen/heterojen Ã¶rnekâ€ Ã§alÄ±ÅŸmasÄ± yapalÄ±m.`;
      }
      if(base.includes("ibadet") || base.includes("dua")){
        return `Ä°badet ve Dua (detay):
â€¢ Ä°badet: Allahâ€™a yÃ¶neliÅŸi gÃ¶steren davranÄ±ÅŸlar. AmaÃ§: kulluk, ÅŸÃ¼kÃ¼r, arÄ±nma.
â€¢ Dua: istek + ÅŸÃ¼kÃ¼r + tÃ¶vbe + yardÄ±m isteme.
â€¢ Dua ederken: samimiyet, gÃ¼zel sÃ¶z, Ä±srar, iyi niyet Ã¶nemlidir.
Ä°stersen bu konudan 5 soru mini test yapayÄ±m.`;
      }
    }

    return null;
  }

  function startTest(textN){
    // "test: karÄ±ÅŸÄ±mlar" / "test: osmanlÄ±" / "test: bÃ¶lme"
    if(!textN.startsWith("test:")) return null;
    const key = normalize(textN.replace("test:","").trim());
    let fullKey = null;
    if(key.includes("karisim")) fullKey = "fen: karÄ±ÅŸÄ±mlar";
    else if(key.includes("osmanli")) fullKey = "tarih: osmanlÄ±";
    else if(key.includes("bolme") || key.includes("bÃ¶lme")) fullKey = "mat: bÃ¶lme";

    if(!fullKey || !MINI_TESTS[fullKey]) return "Test bulamadÄ±m. Åunlardan dene: test: karÄ±ÅŸÄ±mlar / test: osmanlÄ± / test: bÃ¶lme";

    state.testMode = { key: fullKey, qIndex: 0, score: 0 };
    store.set("eb_testMode", state.testMode);

    const q = MINI_TESTS[fullKey][0];
    return `Mini Test baÅŸladÄ± (${fullKey}).\nSoru 1: ${q.q}\nA) ${q.a[0]}\nB) ${q.a[1]}\nC) ${q.a[2]}\nCevabÄ± A/B/C yaz.`;
  }

  function handleTestAnswer(textN){
    if(!state.testMode) return null;
    const ans = textN.trim().toUpperCase();
    if(!["A","B","C"].includes(ans)) return `Test modundayÄ±z. Cevap olarak sadece A / B / C yaz.`;

    const bank = MINI_TESTS[state.testMode.key];
    const q = bank[state.testMode.qIndex];
    const idx = {A:0,B:1,C:2}[ans];

    let out = "";
    if(idx === q.c){
      state.testMode.score += 1;
      out += "âœ… DoÄŸru!\n";
    }else{
      out += `âŒ YanlÄ±ÅŸ. DoÄŸru cevap: ${["A","B","C"][q.c]}\n`;
    }

    state.testMode.qIndex += 1;

    if(state.testMode.qIndex >= bank.length){
      out += `\nTest bitti! Skor: ${state.testMode.score}/${bank.length}\nÄ°stersen yeni test: "test: karÄ±ÅŸÄ±mlar" / "test: osmanlÄ±" / "test: bÃ¶lme"`;
      state.testMode = null;
      store.set("eb_testMode", state.testMode);
      return out.trim();
    }

    store.set("eb_testMode", state.testMode);
    const nq = bank[state.testMode.qIndex];
    out += `Soru ${state.testMode.qIndex+1}: ${nq.q}\nA) ${nq.a[0]}\nB) ${nq.a[1]}\nC) ${nq.a[2]}\nCevabÄ± A/B/C yaz.`;
    return out.trim();
  }

  function coreAnswer(textRaw){
    const textN = normalize(textRaw);

    // Test modu varsa Ã¶nce onu yÃ¶net
    const testReply = handleTestAnswer(textN);
    if(testReply) return testReply;

    // â€œSana bir ÅŸey sormak istiyorumâ€
    if(textN.includes("sana bir sey sormak istiyorum") || textN.includes("sana bir ÅŸey sormak istiyorum")){
      return `Tabiki EMÄ°R BABA, ne istersen yaz ğŸ˜`;
    }

    // Ä°sim kaydet
    if(textN.startsWith("benim adim") || textN.startsWith("benim adÄ±m")){
      const name = textRaw.split(/benim ad[Ä±i]m/i)[1]?.trim() || "";
      if(name){
        setName(name);
        return `Tamam ${state.name}! Ä°smini hatÄ±rladÄ±m âœ…\nÅimdi sorunu yazabilirsin.`;
      }
      return `Ä°smini ÅŸÃ¶yle yaz: "Benim adÄ±m Mehmet"`;
    }

    // yardÄ±m / konular
    if(textN === "yardim" || textN === "yardÄ±m" || textN.includes("yardim et") || textN.includes("yardÄ±m et")){
      return replyHelp();
    }
    if(textN.includes("7. sinif") && (textN.includes("konu") || textN.includes("konular"))){
      return listTopics();
    }

    // test baÅŸlat
    const testStart = startTest(textN);
    if(testStart) return testStart;

    // konu anlat / detay
    const topic = answerTopicExplain(textRaw);
    if(topic) return topic;

    // matematik ifade
    if(looksLikeMath(textRaw)){
      const val = safeEvalMath(textRaw);
      if(val === null) return "Ä°ÅŸlemi okuyamadÄ±m. Ã–rn: 12 bÃ¶lÃ¼ 3 / 25*4 / (10+2)/3";
      return `SonuÃ§: **${val}**`;
    }

    // Fen formÃ¼lleri
    const f = answerScienceFormulas(textN);
    if(f) return f;

    // OsmanlÄ± tarih
    const ott = answerOttoman(textN);
    if(ott) return ott;

    // Fen/Mat/Tarih hÄ±zlÄ± cevaplar (basit Ã¶rnekler)
    if(textN.includes("mitoz") && textN.includes("mayoz")){
      return `Mitoz vs Mayoz (kÄ±sa):
â€¢ Mitoz: BÃ¼yÃ¼me-onarÄ±m; 1 hÃ¼cre â†’ 2 aynÄ± hÃ¼cre (kromozom sayÄ±sÄ± deÄŸiÅŸmez).
â€¢ Mayoz: Ãœreme ana hÃ¼crelerinde; 1 hÃ¼cre â†’ 4 farklÄ± hÃ¼cre (kromozom sayÄ±sÄ± yarÄ±ya iner).`;
    }
    if(textN.includes("mitoz")){
      return `Mitoz (kÄ±sa): BÃ¼yÃ¼me ve onarÄ±m iÃ§in. 1 hÃ¼cre â†’ 2 aynÄ± hÃ¼cre. Kromozom sayÄ±sÄ± deÄŸiÅŸmez.`;
    }
    if(textN.includes("mayoz")){
      return `Mayoz (kÄ±sa): Ãœreme ana hÃ¼crelerinde gÃ¶rÃ¼lÃ¼r. 1 hÃ¼cre â†’ 4 farklÄ± hÃ¼cre. Kromozom sayÄ±sÄ± yarÄ±ya iner.`;
    }

    // Belirsiz ama ders sorusu gibi: direkt â€œne sorduÄŸunuâ€ Ã§Ã¶zmeye Ã§alÄ±ÅŸ
    // EÄŸer kÄ±sa/tek kelimeyse netleÅŸtir
    if(textN.length < 3) return "YazdÄ±ÄŸÄ±nÄ± Ã§ok kÄ±sa gÃ¶rdÃ¼m ğŸ˜… Biraz daha aÃ§Ä±k yazar mÄ±sÄ±n?";

    // Genel fallback (ama â€œaynÄ± cÃ¼mleyiâ€ tekrarlamasÄ±n)
    return `AnladÄ±m. Sorunu daha net cevaplamam iÃ§in cÃ¼mleni biraz uzatÄ±r mÄ±sÄ±n?\nÃ–rn:\nâ€¢ "Konu anlat: KarÄ±ÅŸÄ±mlar"\nâ€¢ "OsmanlÄ±â€™nÄ±n 7. padiÅŸahÄ± kim?"\nâ€¢ "24 bÃ¶lÃ¼ 6"`;
  }

  // --- UI olaylar ---
  function boot(){
    setName(state.name || "");
    clearUI();

    if(state.chat.length === 0){
      pushMsg("bot", replyWelcome());
      state.greeted = true;
      store.set("eb_greeted", true);
    }

    // Quick buttons
    const quicks = [
      'Sana bir ÅŸey sormak istiyorum',
      'Benim adÄ±m Mehmet',
      '7. sÄ±nÄ±f konular',
      'Konu anlat: KarÄ±ÅŸÄ±mlar',
      'Konu anlat: Elektrik devreleri',
      'KarÄ±ÅŸÄ±mlar detay',
      '12 bÃ¶lÃ¼ 3',
      'osmanlÄ±nÄ±n 2. padiÅŸahÄ± kim',
      'istanbulu hangi padiÅŸah fethetti',
      'test: karÄ±ÅŸÄ±mlar',
      'test: osmanlÄ±'
    ];
    const qEl = $("quick");
    qEl.innerHTML = "";
    quicks.forEach(t=>{
      const b=document.createElement("button");
      b.textContent=t;
      b.onclick=()=>{ inputEl.value=t; inputEl.focus(); };
      qEl.appendChild(b);
    });
  }

  function send(){
    const text = inputEl.value.trim();
    if(!text) return;
    inputEl.value = "";
    pushMsg("me", text);

    // Bot cevap
    const reply = coreAnswer(text);
    pushMsg("bot", reply);
  }

  $("send").addEventListener("click", send);
  inputEl.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      send();
    }
  });

  $("helpBtn").addEventListener("click", ()=>pushMsg("bot", replyHelp()));
  $("topicsBtn").addEventListener("click", ()=>pushMsg("bot", listTopics()));
  $("resetBtn").addEventListener("click", ()=>{
    if(!confirm("TÃ¼m sohbet ve kayÄ±tlÄ± isim silinsin mi?")) return;
    localStorage.removeItem("eb_chat");
    localStorage.removeItem("eb_name");
    localStorage.removeItem("eb_greeted");
    localStorage.removeItem("eb_lastTopic");
    localStorage.removeItem("eb_testMode");
    location.reload();
  });

  boot();
})();
</script>
</body>
</html>
